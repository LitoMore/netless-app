import{o as C}from"./index.769f0428.js";import{e as O}from"./ensure-attributes.2c659353.js";import{L as T}from"./logger.8031709a.js";import"./modulepreload-polyfill.b7f2da20.js";import"./randomColor.f00e628f.js";var j=(()=>`.netless-app-embedded-page{width:100%;height:100%;position:relative}.netless-app-embedded-page iframe{width:100%;height:100%;border:none;display:block}.netless-app-embedded-page-wb-view{width:100%;height:100%;position:absolute;top:0;left:0;overflow:hidden}
`)();function b(a){return typeof a=="object"&&a!==null}const B={kind:"EmbeddedPage",setup(a){const S=a.getAppOptions()||{};let g;const{displayer:i,room:n,box:y}=a,E=S.debug,w="state",d=O(a,{src:"https://example.org",store:{[w]:{}},page:""}),p=new C,l=new T("EmbeddedPage",E),m=e=>{try{return b(e)?JSON.parse(JSON.stringify(e)):e}catch(t){throw l.error("Cannot parse to JSON object",e),t}},h=document.createElement("div");h.dataset.appKind="EmbeddedPage",h.classList.add("netless-app-embedded-page");const u=document.createElement("iframe");h.appendChild(u),y.mountStyles(j),y.mountContent(h),y.setHighlightStage(!1);const M=e=>e.map(({memberId:t,payload:s})=>({sessionUID:t,uid:(s==null?void 0:s.uid)||"",userPayload:m(s)})),v=(e,t)=>{let s=null;const r=a.mobxUtils.reaction(e,()=>{s&&(s(),s=null);const o=e();b(o)&&(s=()=>a.objectUtils.unlistenUpdated(o,t),a.objectUtils.listenUpdated(o,t))},{fireImmediately:!0});return()=>{s==null||s(),r()}},c=S.postMessage||(e=>{var t;l.log("Message to SDK",e),(t=u.contentWindow)==null||t.postMessage(e,"*")}),I=S.addMessageListener||((e,t)=>{const s=({data:r,source:o})=>{o!==u.contentWindow||!b(r)||!r.NEAType||(l.log("Message from SDK",r),e(r))};return window.addEventListener("message",s,t),()=>{window.removeEventListener("message",s,t)}});a.getInitScenePath()&&(g=a.createWhiteBoardView());const A=e=>{g&&b(e)&&g.moveCamera({centerX:e.x,centerY:e.y})},P=e=>{b(e)&&Object.keys(e).forEach(t=>{if(t!==w){const s=e[t];a.updateAttributes(["store",t],s)}})},N=e=>{if(b(e)&&e.storeId&&b(e.state)){const{storeId:t,state:s}=e;if(!a.isWritable){l.error(`Cannot setState on store ${t} without writable access`,s);return}Object.keys(s).forEach(r=>{a.updateAttributes(["store",t,r],s[r])})}};p.add(()=>{const e=new C,t=r=>{e.add(()=>v(()=>d.store[r],o=>{c({NEAType:"StateChanged",payload:{storeId:r,actions:m(o)}})}),r)};Object.keys(d.store).forEach(t);const s=v(()=>d.store,r=>{c({NEAType:"StoreChanged",payload:m(r)}),d.store&&r.forEach(({key:o,kind:W})=>{switch(W){case 2:{e.flush(o);break}default:{t(o);break}}})});return()=>{e.flushAll(),s()}}),p.add(()=>{const e=t=>{t!=null&&t.roomMembers&&c({NEAType:"RoomMembersChanged",payload:M(t.roomMembers)})};return i.callbacks.on("onRoomStateChanged",e),()=>i.callbacks.off("onRoomStateChanged",e)});const k=e=>{if(!g)l.warn("SetPage: page api is only available with 'scenePath' options enabled.");else{const t=a.getInitScenePath();if(typeof e=="string"&&a.isWritable&&t&&n){const s=[t,e].join("/");n.scenePathType(s)==="none"&&n.putScenes(t,[{name:e}]),a.setScenePath(s),a.updateAttributes(["page"],e)}}};p.add(()=>{const e=(t,s)=>{c({NEAType:"PageChanged",payload:{oldValue:s,newValue:t}})};return a.mobxUtils.reaction(()=>d.page,e)}),p.add(()=>{const e=()=>{const t=a.isWritable;c({NEAType:"WritableChanged",payload:t}),l.log(`WritableChange changed to ${t}`)};return a.emitter.on("writableChange",e),()=>a.emitter.off("writableChange",e)});const f=`channel-${a.appId}`,L=e=>{a.isWritable&&n&&n.dispatchMagixEvent(f,e)};p.add(()=>{const e=t=>{t.event===f&&t.authorId!==i.observerId&&c({NEAType:"ReceiveMagixMessage",payload:t.payload})};return i.addMagixEventListener(f,e),()=>i.removeMagixEventListener(f,e)});const U=()=>{var s;const e=i.observerId,t=(s=i.state.roomMembers.find(r=>r.memberId===e))==null?void 0:s.payload;c({NEAType:"Init",payload:{appId:a.appId,page:d.page,writable:a.isWritable,roomMembers:M(i.state.roomMembers),debug:E,store:m(d.store),mainStoreId:w,meta:{sessionUID:e,uid:(n==null?void 0:n.uid)||(t==null?void 0:t.uid)||"",roomUUID:n==null?void 0:n.uuid,userPayload:m(t)}}})};p.add(()=>I(e=>{switch(e.NEAType){case"Init":{U();break}case"SetState":{N(e.payload);break}case"SetStore":{P(e.payload);break}case"SetPage":{k(e.payload);break}case"SendMagixMessage":{L(e.payload);break}case"MoveCamera":{A(e.payload);break}}})),a.emitter.on("destroy",()=>{l.log("destroy"),p.flushAll()}),u.src=d.src}};export{B as default};
