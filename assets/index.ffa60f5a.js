import{V as v,L,o as S,w as D,p as E,q as f,u as z,v as A}from"./index.7b411db7.js";import"./modulepreload-polyfill.b7f2da20.js";var M=(()=>`.netless-app-docs-viewer-footer{box-sizing:border-box;height:26px;display:flex;align-items:center;padding:0 16px;border-top:1px solid #eeeef7;font-family:PingFang SC,Source Han Sans SC,Microsoft YaHei,Helvetica Neue,Noto Sans CJK SC,WenQuanYi Micro Hei,sans-serif}.netless-app-docs-viewer-footer-btn{box-sizing:border-box;width:26px;height:26px;font-size:0;margin:0;padding:3px;border:none;border-radius:1px;outline:none;color:currentColor;background:transparent;transition:background .4s;cursor:pointer;user-select:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}.netless-app-docs-viewer-footer-btn:hover{background:rgba(237,237,240,.9)}@media (hover: none){.netless-app-docs-viewer-footer-btn:hover{background:transparent!important}}.netless-app-docs-viewer-footer-btn>svg{width:100%;height:100%}.netless-app-docs-viewer-footer-btn>svg:nth-of-type(2){display:none}.netless-app-docs-viewer-footer-btn.netless-app-docs-viewer-footer-btn-playing>svg:nth-of-type(1){display:none}.netless-app-docs-viewer-footer-btn.netless-app-docs-viewer-footer-btn-playing>svg:nth-of-type(2){display:initial}.netless-app-docs-viewer-footer-btn~.netless-app-docs-viewer-footer-btn{margin-left:15px}.netless-app-docs-viewer-page-jumps{flex:1;display:flex;justify-content:center;align-items:center}.netless-app-docs-viewer-page-number{display:flex;align-items:center;height:26px;margin-left:auto;font-size:13px;user-select:none;white-space:nowrap;word-break:keep-all}.netless-app-docs-viewer-page-number-input{border:none;outline:none;width:3em;margin:0;padding:0 .5em 0 2px;text-align:right;font-size:13px;line-height:1;font-weight:400;font-family:inherit;border-radius:2px;color:currentColor;font-family:PingFang SC,Source Han Sans SC,Microsoft YaHei,Helvetica Neue,Noto Sans CJK SC,WenQuanYi Micro Hei,sans-serif;background:transparent;transition:background .4s;user-select:text;-webkit-tap-highlight-color:rgba(0,0,0,0)}.netless-app-docs-viewer-page-number-input:hover,.netless-app-docs-viewer-page-number-input:focus,.netless-app-docs-viewer-page-number-input:active{background:#fff;box-shadow:#63636333 0 2px 8px}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-footer-btn{cursor:not-allowed}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-footer-btn:hover{background:transparent}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input{cursor:not-allowed}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input:hover,.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input:focus,.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input:active{background:transparent;box-shadow:none}.netless-app-docs-viewer-readonly .netless-app-docs-viewer-page-number-input:disabled{color:inherit}.telebox-color-scheme-dark .netless-app-docs-viewer-page-number-input:active,.telebox-color-scheme-dark .netless-app-docs-viewer-page-number-input:focus,.telebox-color-scheme-dark .netless-app-docs-viewer-page-number-input:hover{color:currentColor;background:#25282e}.telebox-color-scheme-dark .netless-app-docs-viewer-footer{border-top:none}.telebox-color-scheme-dark .netless-app-docs-viewer-footer-btn:hover{background:#212126}.netless-app-docs-viewer-preview.netless-app-docs-viewer-preview-active{transform:translate(0)}.netless-app-docs-viewer-content{position:relative;height:100%;overflow:hidden}.netless-app-docs-viewer-preview-mask{position:absolute;z-index:10200;top:0;left:0;width:100%;height:100%}.netless-app-docs-viewer-preview{box-sizing:border-box;display:flex;flex-direction:column;align-items:center;position:absolute;z-index:10300;top:0;left:0;width:33%;max-width:200px;height:100%;padding-top:10px;transform:translate(-100%);background:rgba(237,237,240,.9);box-shadow:inset -1px 0 #0000001c;transition:transform .4s}.netless-app-docs-viewer-preview-active .netless-app-docs-viewer-preview-mask{display:block}.netless-app-docs-viewer-preview-active .netless-app-docs-viewer-preview{transform:translate(0)}.netless-app-docs-viewer-preview-page{position:relative;display:block;width:55%;margin-bottom:10px;font-size:0;color:transparent;outline:none;border:7px solid transparent;border-radius:4px;transition:border-color .3s;user-select:none}.netless-app-docs-viewer-preview-page:hover,.netless-app-docs-viewer-preview-page.netless-app-docs-viewer-preview-page-active{border-color:#444e601a}.netless-app-docs-viewer-preview-page>img{width:100%;height:auto;box-sizing:border-box;border:1px solid rgba(0,0,0,.5);border-radius:1px;background-color:#fff;box-shadow:0 2px 8px #0000004d}.netless-app-docs-viewer-preview-page-name{position:absolute;top:1px;left:-10px;transform:translate(-100%);text-align:right;font-size:12px;user-select:none}.telebox-color-scheme-dark .netless-app-docs-viewer-preview{background:rgba(50,50,50,.9)}.netless-app-docs-viewer-static-scrollbar{box-sizing:border-box;position:absolute;top:0;right:0;z-index:2147483647;width:16px;min-height:30px;margin:0;padding:0 0 0 8px;border:none;outline:none;opacity:0;background:transparent;transition:opacity .4s 3s,transform .1s;user-select:none;touch-action:none}.netless-app-docs-viewer-static-scrollbar:after{content:"";display:block;width:8px;height:100%;border-radius:4px;background:rgba(68,78,96,.4);box-shadow:1px 1px 8px #ffffffb3;transition:background .4s}.netless-app-docs-viewer-static-scrollbar.netless-app-docs-viewer-static-scrolling{opacity:1;transition:opacity .4s,transform .1s}.netless-app-docs-viewer-static-scrollbar.netless-app-docs-viewer-static-scrollbar-dragging{opacity:1;transition:opacity .4s 3s!important}.netless-app-docs-viewer-static-scrollbar.netless-app-docs-viewer-static-scrollbar-dragging:after{background:rgba(68,78,96,.6)}.netless-app-docs-viewer-static-scrollbar:hover:after,.netless-app-docs-viewer-static-scrollbar:focus:after{background:rgba(68,78,96,.5)}.netless-app-docs-viewer-static-scrollbar:active:after{background:rgba(68,78,96,.6)}.telebox-body-wrap:hover .netless-app-docs-viewer-static-scrollbar{opacity:1;transition:opacity .4s,transform .1s}.telebox-readonly .netless-app-docs-viewer-static-scrollbar{display:none}.page-renderer-pages-container{position:relative;width:100%;height:100%}.page-renderer-page{position:absolute;top:0;left:0;background-position:center;background-size:cover;background-repeat:no-repeat}.page-renderer-pages-container.is-hwa .page-renderer-page{will-change:transform}.page-renderer-page-img{display:block;width:100%;height:auto;user-select:none}.netless-app-docs-viewer-static-pages{overflow:hidden;position:relative;height:100%;user-select:none}.netless-app-docs-viewer-static-page{display:block;width:100%;height:auto;user-select:none}.netless-app-docs-viewer-dynamic-wb-view{position:absolute;top:0;left:0;width:100%;height:100%;z-index:100;overflow:hidden}.netless-app-docs-viewer-dynamic-wb-view .cursor-clicker .ppt-event-source{cursor:pointer}
`)();class V{constructor({namespace:e,pages$:t,sideEffect:s,readonly$:r,events:a,wrapClassName:n,root:o,pagesIndex$:h}){this.showPreview$=new v(!1),this.namespace=e,this.pages$=t,this.sideEffect=s,this.readonly$=r,this.events=a,this.wrapClassName=n,this.sideEffect.addDisposer(this.events.on("togglePreview",()=>{this.showPreview$.setValue(!this.showPreview$.value)})),this.sideEffect.addDisposer(this.showPreview$.subscribe(i=>{this.sideEffect.add(()=>{const c=this.renderPreview(),d=this.renderPreviewMask();if(i){o.appendChild(c),o.appendChild(d),c.scrollTop;const u=c.querySelector("."+this.wrapClassName(`preview-page-${h.value}`));return u&&c.scrollTo({top:u.offsetTop-16}),c.classList.toggle(this.wrapClassName("preview-active"),!0),this.previewLazyLoad=new L({container:this.$preview,elements_selector:"."+this.wrapClassName("preview-page>img")}),()=>{var p;return(p=this.previewLazyLoad)==null?void 0:p.destroy()}}else return c.classList.toggle(this.wrapClassName("preview-active"),!1),this.sideEffect.setTimeout(()=>{c.remove(),d.remove()},500,"preview-remove"),null},"preview-lazyload")}))}destroy(){var e,t;(e=this.$preview)==null||e.remove(),(t=this.$previewMask)==null||t.remove()}renderPreview(){if(this.$preview)return this.$preview;const e=document.createElement("div");return e.className=this.wrapClassName("preview")+" tele-fancy-scrollbar",this.$preview=e,this.sideEffect.addEventListener(e,"wheel",t=>t.stopPropagation(),{passive:!1}),this.sideEffect.addDisposer(this.pages$.subscribe(t=>{var s;this.sideEffect.add(()=>{const r=t.map((a,n)=>{var u;const o=(u=a.thumbnail)!=null?u:a.src.startsWith("ppt")?void 0:a.src;if(!o)return;const h=String(n),i=document.createElement("a");i.className=this.wrapClassName("preview-page")+" "+this.wrapClassName(`preview-page-${n}`),i.setAttribute("href","#"),i.dataset.pageIndex=h;const c=document.createElement("span");c.className=this.wrapClassName("preview-page-name"),c.textContent=String(n+1),c.dataset.pageIndex=h;const d=document.createElement("img");return d.width=a.width,d.height=a.height,d.dataset.src=o,d.dataset.pageIndex=h,i.appendChild(d),i.appendChild(c),e.appendChild(i),i});return()=>r.forEach(a=>a==null?void 0:a.remove())},"render-preview-pages"),(s=this.previewLazyLoad)==null||s.update()})),this.sideEffect.addEventListener(e,"click",t=>{var r;if(this.readonly$.value)return;const s=(r=t.target.dataset)==null?void 0:r.pageIndex;s&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.events.emit("jumpPage",Number(s)),this.showPreview$.setValue(!1))}),e}renderPreviewMask(){if(this.$previewMask)return this.$previewMask;const e=document.createElement("div");return e.className=this.wrapClassName("preview-mask"),this.$previewMask=e,this.sideEffect.addEventListener(e,"click",t=>{this.readonly$.value||t.target===e&&this.showPreview$.setValue(!1)}),e}}function R(l){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${l}-footer-icon-sidebar`),t.setAttribute("viewBox","0 0 64 64");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M50 8H14c-3.309 0-6 2.691-6 6v36c0 3.309 2.691 6 6 6h36c3.309 0 6-2.691 6-6V14c0-3.309-2.691-6-6-6zM12 50V14c0-1.103.897-2 2-2h8v40h-8c-1.103 0-2-.897-2-2zm40 0c0 1.103-.897 2-2 2H26V12h24c1.103 0 2 .897 2 2z"),t.appendChild(s),t}function _(l){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${l}-footer-icon-arrow-left`),t.setAttribute("viewBox","0 0 500 500");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M177.81 249.959L337.473 90.295c2.722-2.865 2.651-7.378-.143-10.1-2.793-2.65-7.163-2.65-9.956 0l-164.75 164.75c-2.793 2.793-2.793 7.306 0 10.1l164.75 164.75c2.865 2.722 7.378 2.65 10.099-.143 2.651-2.794 2.651-7.163 0-9.957L177.809 249.959z"),t.appendChild(s),t}function I(l){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${l}-footer-icon-arrow-right`),t.setAttribute("viewBox","0 0 500 500");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M322.19 250.041L162.527 409.705c-2.722 2.865-2.651 7.378.143 10.1 2.793 2.65 7.163 2.65 9.956 0l164.75-164.75c2.793-2.793 2.793-7.306 0-10.1l-164.75-164.75c-2.865-2.722-7.378-2.65-10.099.143-2.651 2.794-2.651 7.163 0 9.957l159.664 159.736z"),t.appendChild(s),t}function B(l){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${l}-footer-icon-play`),t.setAttribute("viewBox","0 0 500 500");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M418.158 257.419L174.663 413.33c-6.017 3.919-15.708 3.772-21.291-.29-2.791-2.018-4.295-4.483-4.295-7.084V94.109c0-5.65 6.883-10.289 15.271-10.289 4.298 0 8.391 1.307 11.181 3.332l242.629 155.484c6.016 3.917 6.451 10.292.649 14.491-.216.154-.432.154-.649.292zM170.621 391.288l223.116-141.301L170.71 107.753l-.089 283.535z"),t.appendChild(s),t}function H(l){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.setAttribute("class",`${l}-footer-icon-pause`),t.setAttribute("viewBox","0 0 500 500");const s=document.createElementNS(e,"path");return s.setAttribute("fill","currentColor"),s.setAttribute("d","M312.491 78.261c0-6.159 4.893-11.213 11.04-11.213 6.158 0 11.211 5.054 11.211 11.213v343.478c0 6.159-5.053 11.213-11.211 11.213-6.147 0-11.04-5.054-11.04-11.213V78.261zM165.257 78.261c0-6.159 4.893-11.213 11.04-11.213 6.158 0 11.211 5.054 11.211 11.213v343.478c0 6.159-5.053 11.213-11.211 11.213-6.147 0-11.04-5.054-11.04-11.213V78.261z"),t.appendChild(s),t}class U{constructor({namespace:e,pages$:t,sideEffect:s,readonly$:r,events:a,playable:n,wrapClassName:o,pagesIndex$:h,root:i}){this.namespace=e,this.pages$=t,this.sideEffect=s,this.readonly$=r,this.events=a,this.wrapClassName=o,this.pagesIndex$=h,this.playable=n,this.$footer=this.render(),i.appendChild(this.$footer)}destroy(){this.$footer.remove()}render(){const e=document.createElement("div");e.className=this.wrapClassName("footer"),this.sideEffect.addDisposer(this.readonly$.subscribe(i=>e.classList.toggle(this.wrapClassName("readonly"),i)));const t=this.renderFooterBtn("btn-sidebar",R(this.namespace));this.sideEffect.addEventListener(t,"click",()=>{this.readonly$.value||this.events.emit("togglePreview")}),e.appendChild(t),this.sideEffect.addDisposer(this.pages$.subscribe(i=>{const c=i.some(d=>d.thumbnail||!d.src.startsWith("ppt"));t.style.display=c?"":"none"}));const s=document.createElement("div");s.className=this.wrapClassName("page-jumps");const r=this.renderFooterBtn("btn-page-back",_(this.namespace));if(this.sideEffect.addEventListener(r,"click",()=>{this.readonly$.value||this.events.emit("back")}),s.appendChild(r),this.playable){const i=this.renderFooterBtn("btn-page-play",B(this.namespace),H(this.namespace));this.sideEffect.addEventListener(i,"click",()=>{this.readonly$.value||(i.classList.toggle(this.wrapClassName("footer-btn-playing"),!0),this.events.emit("play"),this.sideEffect.setTimeout(()=>i.classList.toggle(this.wrapClassName("footer-btn-playing"),!1),500,"returnPlay"))}),s.appendChild(i)}const a=this.renderFooterBtn("btn-page-next",I(this.namespace));this.sideEffect.addEventListener(a,"click",()=>{this.readonly$.value||this.events.emit("next")}),s.appendChild(a);const n=document.createElement("div");n.className=this.wrapClassName("page-number");const o=document.createElement("input");o.className=this.wrapClassName("page-number-input"),this.sideEffect.addDisposer(this.readonly$.subscribe(i=>o.disabled=i)),this.sideEffect.addDisposer(this.pagesIndex$.subscribe(i=>o.value=String(i+1))),this.sideEffect.addEventListener(o,"focus",()=>{o.select()}),this.sideEffect.addEventListener(o,"change",()=>{if(this.readonly$.value)return;const i=Number(o.value)-1;i>=0&&this.events.emit("jumpPage",i)});const h=document.createElement("span");return this.sideEffect.addDisposer(this.pages$.subscribe(i=>{h.textContent=" / "+i.length})),n.appendChild(o),n.appendChild(h),e.appendChild(s),e.appendChild(n),e}renderFooterBtn(e,t,s){const r=document.createElement("button");return r.className=this.wrapClassName("footer-btn")+" "+this.wrapClassName(e),r.appendChild(t),s&&r.appendChild(s),r}}class F{constructor(){this.listeners=new Map,this.relayListeners=new Set}emit(e,t){var s;(s=this.listeners.get(e))==null||s.forEach(r=>r(t))}on(e,t){let s=this.listeners.get(e);return s||(s=new Set,this.listeners.set(e,s)),s.add(t),s.size===1&&this.relayListeners.forEach(r=>r.start(e)),()=>{this.off(e,t)}}off(e,t){const s=this.listeners.get(e);if(s){const r=s.delete(t);return s.size<=0&&(this.listeners.delete(e),this.relayListeners.forEach(a=>a.dispose(e))),r}return!1}clear(e){var t;e?(t=this.listeners.get(e))==null||t.clear():this.listeners.clear()}count(e){var t;if(e)return((t=this.listeners.get(e))==null?void 0:t.size)||0;{let s=0;return this.listeners.forEach(r=>{s+=r.size}),s}}remit(e,t){let s;const r={start:a=>{a===e&&(s=t(this))},dispose:a=>{s&&(!a||a===e)&&s()}};return this.relayListeners.add(r),()=>{this.relayListeners.delete(r),s&&s()}}destroy(){this.clear(),this.relayListeners.forEach(e=>e.dispose()),this.relayListeners.clear()}}class N{constructor({readonly$:e,pagesIndex$:t,box:s,pages:r=[],playable:a}){this.wrapClassName=o=>`${this.namespace}-${o}`,this.namespace="netless-app-docs-viewer",this.sideEffect=new S,this.events=new F;const n=new v(r);D(this,{pages:n}),this.preview=new V({pages$:n,readonly$:e,pagesIndex$:t,root:s.$body,sideEffect:this.sideEffect,events:this.events,namespace:this.namespace,wrapClassName:this.wrapClassName}),this.footer=new U({pages$:n,readonly$:e,playable:a,pagesIndex$:t,root:s.$footer,namespace:this.namespace,sideEffect:this.sideEffect,events:this.events,wrapClassName:this.wrapClassName})}destroy(){this.preview.destroy(),this.footer.destroy(),this.sideEffect.flushAll(),this.events.destroy()}}function y(l,e,t){return Math.min(Math.max(l,e),t)}function k(l){return l.touches?l.touches[0]:l}function T(l){l.stopPropagation(),l.cancelable&&l.preventDefault()}function P(l,e){return l.width===e.width&&l.height===e.height}class Y{constructor(e){var t,s,r;this.velocity=0,this._paused=!0,this._animationFrameID=null,this._loopTimestamp=0,this.looper=a=>{var o;if(this._paused)return;let n=Math.floor((a-this._loopTimestamp)/1e3*60)+1;for(this._loopTimestamp=a;n-- >0;)this.stepper();(o=this.onStep)==null||o.call(this,this.current),this._paused?this._animationFrameID=null:this._animationFrameID=window.requestAnimationFrame(this.looper)},this.current=(t=e.start)!=null?t:0,this.target=this.current,this.stiffness=(s=e.stiffness)!=null?s:170,this.damping=(r=e.damping)!=null?r:26,this.onStep=e.onStep}get paused(){return this._paused}stepTo(e,t){var s;this._paused&&t!=null&&(this.current=t),this._paused=!1,this.target=e,(s=this.onStep)==null||s.call(this,this.current),this._loopTimestamp=Date.now(),this._animationFrameID=window.requestAnimationFrame(this.looper)}pause(){this._paused=!0,this._animationFrameID!=null&&window.cancelAnimationFrame(this._animationFrameID)}destroy(){this.pause(),this.onStep=void 0}stepper(){const e=-this.stiffness*(this.current-this.target),t=-this.damping*this.velocity,s=this.velocity+(e+t)/60,r=this.current+s/60;Math.abs(s-0)<.01&&Math.abs(r-this.target)<.01?(this.current=this.target,this.velocity=0,this._paused=!0):(this.current=r,this.velocity=s)}}class W{constructor(e,t,s,r,a,n){this.index=e,this.lastVisit=Date.now(),this.sideEffect=new S;const o=E(t,u=>u[e]||{width:0,height:0}),h=f([o,s],([u,p])=>(p.width-u.width)/2),i=f([a,n],([u,p])=>(u[e]||0)-p),c=document.createElement("div");c.className="page-renderer-page",c.dataset.index=`${e}`;const d=document.createElement("img");d.className="page-renderer-page-img",c.appendChild(d),this.sideEffect.addDisposer([f([o,r]).subscribe(([u,p])=>{c.style.width=`${u.width*p}px`,c.style.height=`${u.height*p}px`}),o.subscribe(u=>{u.thumbnail&&(c.style.backgroundImage=`url("${u.thumbnail}")`),d.width=u.width,d.height=u.height,d.src=u.src}),f([h,i,r]).subscribe(([u,p,g])=>{c.style.transform=`translate(${u*g}px, ${p*g}px)`})]),this.$page=c}destroy(){this.sideEffect.flushAll(),this.$page.remove()}}const j=window.requestIdleCallback||(l=>window.setTimeout(l,5e3)),O=window.cancelIdleCallback||window.clearTimeout;class q{constructor(e,t,s,r,a){this.pages$=e,this.pagesSize$=t,this.scale$=s,this.pagesYs$=r,this.pagesScrollTop$=a,this.els=new Map,this.maxElCount=200,this.gcTimer=null,this.gc=()=>{var n;if(this.gcTimer=null,this.els.size>this.maxElCount){const o=[...this.els.values()].sort((h,i)=>i.lastVisit-h.lastVisit);for(let h=Math.floor(this.maxElCount/4);h<o.length;h++)(n=this.els.get(o[h].index))==null||n.destroy(),this.els.delete(o[h].index)}}}getEl(e){let t=this.els.get(e);return t||(t=new W(e,this.pages$,this.pagesSize$,this.scale$,this.pagesYs$,this.pagesScrollTop$),this.els.set(e,t)),t.lastVisit=Date.now(),this.els.size>this.maxElCount&&this.gcTimer===null&&(this.gcTimer=j(this.gc)),t}destroy(){this.els.forEach(e=>e.destroy()),this.els.clear(),this.gcTimer!==null&&(O(this.gcTimer),this.gcTimer=null)}}class G{constructor({pagesScrollTop$:e,containerRect$:t,pages$:s,pagesSize$:r}){this.sideEffect=new S,s=E(s,p=>p.map(g=>{if(g.thumbnail)return g;try{const w=new URL(g.src);return w.searchParams.set("x-oss-process","image/resize,l_50"),{...g,thumbnail:w.toString()}}catch(w){return console.error(w),g}}));const a=E(s,p=>{const g=Array(p.length);for(let w=0;w<p.length;w++)g[w]=w>0?g[w-1]+p[w-1].height:0;return g}),n=E(s,p=>{let g=1/0;for(let w=p.length-1;w>=0;w--)p[w].height<=g&&(g=p[w].height);return g}),o=f([e,a,s],([p,g,w])=>{for(let m=0;m<g.length;m++)if(g[m]+w[m].height-p>=.001)return m;return g.length-1}),h=f([t,r],([p,g])=>p.width/g.width||1),i=f([s,t,n,h],([p,g,w,m])=>y(Math.ceil(g.height/m/w/2),1,p.length));z(this,{pagesScrollTop:e,containerRect:t,pages:s,pagesSize:r,pagesIndex:o,pagesYs:a,pagesMinHeight:n,scale:h}),this.pageElManager=new q(s,r,h,a,e),this.$pages=this.renderPages();const c=new v(!1);this.sideEffect.addDisposer(c.subscribe(p=>this.$pages.classList.toggle("is-hwa",p)));const d=()=>c.setValue(!1),u=()=>{this.sideEffect.setTimeout(d,1e3,"turn-off-hwa"),c.setValue(!0)};this.sideEffect.addDisposer(f([o,i,s]).subscribe(([p,g,w])=>{u();const m=Math.max(p-g,0),x=Math.min(p+g,w.length-1);for(let b=0;b<this.$pages.children.length;b++){const $=this.$pages.children[b],C=Number($.dataset.index);C>=m&&C<=x||($.remove(),b--)}for(let b=m;b<=x;b++){const $=this.pageElManager.getEl(b);$.$page.parentElement!==this.$pages&&this.$pages.appendChild($.$page)}}))}renderPages(){const e=document.createElement("div");return e.className="page-renderer-pages-container",this.sideEffect.addDisposer(this._containerRect$.subscribe(t=>{e.style.width=`${t.width}px`,e.style.height=`${t.height}px`}),"render-pages-size"),e}destroy(){this.sideEffect.flushAll(),this.$pages.remove(),this.pageElManager.destroy()}}const J=30;class X{constructor({pagesScrollTop$:e,containerRect$:t,stageRect$:s,pagesSize$:r,readonly$:a,scrollbarMinHeight:n=J,wrapClassName:o,onDragScroll:h}){this.sideEffect=new S,this.scrolling$=new v(!1),this.pagesScrollTop$=e,this.containerRect$=t,this.stageRect$=s,this.pagesSize$=r,this.scrollbarMinHeight=n,this.readonly$=a,this.wrapClassName=o,this.onDragScroll=h,this.scrollbarHeight$=f([t,s,r],([i,c,d])=>y(c.height/(c.width/d.width*d.height)*i.height,n,i.height)),this.scrollTop$=f([t,s,r,this.scrollbarHeight$,this.pagesScrollTop$],([i,c,d,u,p])=>y(p/(d.height-d.width/c.width*c.height)*(i.height-u),0,i.height-u)),this.$scrollbar=this.renderScrollbar()}mount(e){e.appendChild(this.$scrollbar)}destroy(){this.$scrollbar.remove(),this.onDragScroll=void 0,this.sideEffect.flushAll()}renderScrollbar(){const e=document.createElement("button");e.className=this.wrapClassName("scrollbar"),e.style.minHeight=`${this.scrollbarMinHeight}px`,this.sideEffect.addDisposer([this.scrollbarHeight$.subscribe(s=>{e.style.height=`${s}px`}),this.scrollTop$.subscribe(s=>{this.scrolling$.setValue(!0),this.sideEffect.setTimeout(()=>this.scrolling$.setValue(!1),100,"reset-scrolling");const r=()=>e.style.transform=`translateY(${s}px)`;window.requestAnimationFrame?window.requestAnimationFrame(r):r()}),this.scrolling$.subscribe(s=>{e.classList.toggle(this.wrapClassName("scrolling"),s)})]);const t=s=>{if(!s.isPrimary||this.readonly$.value||s.button!=null&&s.button!==0)return;T(s);const r=this.wrapClassName("scrollbar-dragging");e.classList.toggle(r,!0);const a=this.pagesScrollTop$.value,{clientY:n}=k(s),o=i=>{if(!i.isPrimary||this.readonly$.value)return;const{clientY:c}=k(i),d=c-n;Math.abs(d)>0&&this.onDragScroll&&this.onDragScroll(a+d/this.containerRect$.value.height*this.pagesSize$.value.height)},h=i=>{!i.isPrimary||(e.classList.toggle(r,!1),window.removeEventListener("pointermove",o,!0),window.removeEventListener("pointerup",h,!0),window.removeEventListener("pointercancel",h,!0))};window.addEventListener("pointermove",o,!0),window.addEventListener("pointerup",h,!0),window.addEventListener("pointercancel",h,!0)};return this.sideEffect.addEventListener(e,"pointerdown",t),e}}class K{constructor({whiteboard:e,readonly$:t,box:s,pages:r,pagesScrollTop:a=0,onUserScroll:n}){this.sideEffect=new S,this.userScrolling=!1,this.whiteboard=e,this.readonly$=t,this.box=s,this.pages=r,this.onUserScroll=n;const o=()=>{var i;this.userScrolling=!1,(i=this.onUserScroll)==null||i.call(this,this.pagesScrollTop$.value)};this.debounceOnUserScroll=()=>{this.userScrolling=!0,this.sideEffect.setTimeout(o,80,"debounceOnUserScroll")};const h=new v(r);this.pagesScrollTop$=new v(a),this.pagesSize$=E(h,i=>{let c=0,d=0;for(let u=i.length-1;u>=0;u--){const p=i[u];p.width>c&&(c=p.width),d+=p.height}return{width:Math.max(1,c),height:Math.max(1,d)}},{compare:P}),this.pageRenderer=new G({pagesScrollTop$:this.pagesScrollTop$,containerRect$:s._stageRect$,pages$:h,pagesSize$:this.pagesSize$}),this.viewer=new N({readonly$:t,pagesIndex$:this.pageRenderer._pagesIndex$,box:s,pages:r,playable:!1}),this.sideEffect.addDisposer([this.viewer.events.on("next",()=>{this.userScrollByPercent(.8)}),this.viewer.events.on("back",()=>{this.userScrollByPercent(-.8)})]),this.scrollbar=new X({pagesScrollTop$:this.pagesScrollTop$,containerRect$:s._bodyRect$,stageRect$:s._stageRect$,pagesSize$:this.pagesSize$,readonly$:t,wrapClassName:this.wrapClassName.bind(this),onDragScroll:i=>{this.pageScrollTo(i),this.debounceOnUserScroll()}}),this.pageScrollStepper=new Y({start:this.pagesScrollTop$.value,onStep:i=>{this.pageScrollTo(i)}}),this.sideEffect.addDisposer(this.viewer.events.on("jumpPage",i=>this.userScrollToPageIndex(i))),this.render(),this.setupScrollListener(),this.sideEffect.setTimeout(()=>{this.userScrolling||this.pageScrollTo(this.pageRenderer.pagesScrollTop)},100)}get pagesScrollTop(){return this.pagesScrollTop$.value}destroy(){this.sideEffect.flushAll(),this.pageScrollStepper.destroy(),this.onUserScroll=void 0,this.viewer.destroy(),this.pageRenderer.destroy(),this.scrollbar.destroy()}syncPageScrollTop(e){!this.userScrolling&&e>=0&&Math.abs(this.pagesScrollTop$.value-e)>.01&&this.pageScrollStepper.stepTo(e,this.pagesScrollTop$.value)}render(){this.box.$content.style.overflow="hidden",this.box.mountStage(this.pageRenderer.$pages),this.scrollbar.mount(this.box.$body)}pageScrollTo(e){const t=this.whiteboard.view.size.height/2/this.pageRenderer.scale;this.whiteboard.view.moveCamera({centerY:y(e+t,t,this.pagesSize$.value.height-t),animationMode:"immediately"})}userScrollToPageIndex(e){var t;if(e=y(e,0,this.pages.length-1),!this.readonly$.value&&!Number.isNaN(e)){const s=this.pageRenderer.pagesYs[e];s>=0&&((t=this.onUserScroll)==null||t.call(this,s+5/this.pageRenderer.scale))}}userScrollByPercent(e){var t;this.readonly$.value||(t=this.onUserScroll)==null||t.call(this,y(this.pageRenderer.pagesScrollTop+this.pageRenderer.containerRect.height/this.pageRenderer.scale*y(e,-1,1),0,this.pageRenderer.pagesSize.height-this.pageRenderer.containerRect.height/this.pageRenderer.scale))}setupScrollListener(){this.sideEffect.addEventListener(this.box.$main,"wheel",e=>{T(e),!this.readonly$.value&&this.pageScrollStepper.paused&&(this.pageScrollTo(this.pagesScrollTop+e.deltaY),this.debounceOnUserScroll())},{passive:!1}),this.sideEffect.addEventListener(this.box.$main,"touchmove",e=>{!this.readonly$.value&&e.touches.length>1&&this.debounceOnUserScroll()},{passive:!0,capture:!0}),this.sideEffect.add(()=>{const e=t=>{const{width:s,height:r}=this.whiteboard.view.size;if(s<=0||r<=0)return;const a=t.centerY-this.pageRenderer.containerRect.height/this.pageRenderer.scale/2;this.pagesScrollTop$.setValue(a)};return this.whiteboard.view.callbacks.on("onCameraUpdated",e),()=>this.whiteboard.view.callbacks.off("onCameraUpdated",e)}),this.sideEffect.addDisposer(this.box._stageRect$.subscribe(e=>{const{width:t,height:s}=this.pagesSize$.value;this.whiteboard.view.moveCameraToContain({originX:0,originY:this.pageRenderer.pagesScrollTop,width:t,height:e.height/this.pageRenderer.scale,animationMode:"immediately"}),this.whiteboard.view.setCameraBound({damping:1,maxContentMode:()=>this.pageRenderer.scale,minContentMode:()=>this.pageRenderer.scale,centerX:t/2,centerY:s/2,width:t,height:s})}),"whiteboard-size-update"),this.sideEffect.addEventListener(window,"keyup",e=>{if(!(this.readonly$.value||!this.box.focus||this.box.minimized))switch(e.key){case"PageDown":{this.userScrollByPercent(.8);break}case"PageUp":{this.userScrollByPercent(-.8);break}case"ArrowLeft":{this.userScrollByPercent(-.25);break}case"ArrowRight":{this.userScrollByPercent(.25);break}case"ArrowDown":{this.userScrollByPercent(.5);break}case"ArrowUp":{this.userScrollByPercent(-.5);break}}},{capture:!0})}wrapClassName(e){return"netless-app-docs-viewer-static-"+e}}class Q{constructor({readonly$:e,context:t,whiteboard:s,box:r,pages:a}){this.sideEffect=new S,this.context=t,this.whiteboard=s,this.box=r,this.pages=a;const n=new v(t.displayer.state.sceneState.index||0);this.pagesIndex$=n,this.sideEffect.add(()=>{const o=h=>{this.jumpToPage(h.index)};return this.context.emitter.on("sceneStateChange",o),()=>this.context.emitter.off("sceneStateChange",o)}),this.viewer=new N({readonly$:e,pagesIndex$:n,box:r,pages:a,playable:!0}),this.sideEffect.addDisposer([this.viewer.events.on("jumpPage",o=>this.jumpToPage(o,!0)),this.viewer.events.on("play",()=>{var o;return(o=this.context.room)==null?void 0:o.pptNextStep()}),this.viewer.events.on("back",()=>this.prevPage()),this.viewer.events.on("next",()=>this.nextPage())]),this.render(),this.sideEffect.addDisposer(n.subscribe((o,h)=>{var d,u;if(e.value)return;const i=this.context.getInitScenePath(),c=(u=(d=this.context.getScenes())==null?void 0:d[o])==null?void 0:u.name;if(i&&c&&this.context.setScenePath(`${i}/${c}`),h){const p=this.context.room;if(p){const g=p.state.globalState.__pptState;p.setGlobalState({__pptState:g&&{uuid:g.uuid,pageIndex:o,disableAutoPlay:g.disableAutoPlay}})}}}))}destroy(){this.sideEffect.flushAll(),this.viewer.destroy()}nextPage(){this.jumpToPage(this.pagesIndex$.value+1,!0)}prevPage(){this.jumpToPage(this.pagesIndex$.value-1,!0)}jumpToPage(e,t=!1){this.pagesIndex$.setValue(y(e,0,this.pages.length-1),t)}render(){var t;this.box.mountStage(document.createElement("div")),this.sideEffect.addEventListener(window,"keydown",s=>{var r;if(this.box.focus)switch(s.key){case"ArrowUp":case"ArrowLeft":{this.prevPage();break}case"ArrowRight":case"ArrowDown":{(r=this.context.room)==null||r.pptNextStep();break}}});const e=(t=this.whiteboard.view.divElement)==null?void 0:t.parentElement;e&&this.sideEffect.addEventListener(e,"click",s=>{var a;const r=this.context.room;if(r&&r.state.memberState.currentApplianceName==="clicker"){for(let n=s.target;n;n=n.parentElement)if((a=n.classList)!=null&&a.contains("ppt-event-source"))return;r.pptNextStep()}})}wrapClassName(e){return"netless-app-docs-viewer-dynamic-"+e}}const ie={kind:A,setup(l){const e=l.box,t=l.getScenes();if(!t)throw new Error("[Docs Viewer]: scenes not found.");const s=new S,r=t.map(({ppt:n})=>n?{width:n.width,height:n.height,src:n.src,thumbnail:n.previewURL}:null).filter(n=>Boolean(n));if(r.length<=0)throw new Error("[Docs Viewer]: empty scenes.");e.mountStyles(M);const a=new v(!l.isWritable);s.addDisposer(l.emitter.on("writableChange",n=>{a.setValue(!n)})),r[0].src.startsWith("ppt")?ee(s,l,e,r,a):Z(s,l,e,r,a),s.addDisposer(l.emitter.on("destroy",()=>{s.flushAll()}))}};function Z(l,e,t,s,r){const a=e.createWhiteBoardView({syncCamera:!1});l.addDisposer(r.subscribe(i=>{a.view.disableCameraTransform=i}));const n=e.createStorage("static-docs-viewer",{pagesScrollTop:0}),o=new K({whiteboard:a,readonly$:r,box:t,pages:s,pagesScrollTop:n.state.pagesScrollTop,onUserScroll:i=>{e.isWritable&&n.setState({pagesScrollTop:i})}});l.addDisposer(()=>o.destroy()),l.addDisposer(n.addStateChangedListener(i=>{i.pagesScrollTop&&o.syncPageScrollTop(i.pagesScrollTop.newValue||0)}));let h=1;if(s.length>0){const{width:i,height:c}=s[0];c<=i?h=c/i:h=1/2*c/i}l.addDisposer(f([t._maximized$,t._managerStageRect$,t._intrinsicSize$],([i,c,d])=>i?h:d.height*(c.height/c.width)/d.width).subscribe(i=>{t.setStageRatio(i)}))}function ee(l,e,t,s,r){const a=e.createWhiteBoardView();a.view.disableCameraTransform=!0;const n=new Q({context:e,whiteboard:a,box:t,pages:s,readonly$:r});l.addDisposer(()=>n.destroy());const o=new v({width:s[0].width,height:s[0].height},{compare:P});if(l.addDisposer(n.pagesIndex$.subscribe(h=>{const i=s[h];i&&o.setValue({width:i.width,height:i.height})})),l.addDisposer(o.subscribe(h=>{r.value||a.setBaseRect(h)})),e.isAddApp){const h=l.add(()=>{const i=({width:c,height:d})=>{if(s.length>0&&t.state!=="maximized"){const{width:u,height:p}=s[0],w=p/u*c-d;w!==0&&e.isWritable&&e.emitter.emit("setBoxSize",{width:t.intrinsicWidth,height:t.intrinsicHeight+w/t.rootRect.height})}l.remove(h)};return a.view.callbacks.once("onSizeUpdated",i),()=>a.view.callbacks.off("onSizeUpdated",i)})}}export{ie as default};
