import{o as m,G as l,H as S,I as f}from"./index.b50c7568.js";import{G as A,J as R,H as $}from"./index.b50c7568.js";import"./modulepreload-polyfill.b7f2da20.js";const v=void 0,D={kind:"Slide",setup(e){var n,a;if(console.log("[Slide] setup @ "+void 0),!e.storage.state.taskId)throw new Error("[Slide] no taskId");const t=e.getAppOptions()||{},r=b(e);r.info("[Slide] setup @ "+void 0);const o=new m,s=new l({interactive:!0,mode:"interactive",resize:!0,enableGlobalClick:!0,timestamp:c(e),logger:r,renderOptions:{minFPS:t.minFPS||25,maxFPS:t.maxFPS||30,autoFPS:(n=t.autoFPS)!=null?n:!0,autoResolution:(a=t.autoResolution)!=null?a:!0,resolution:t.resolution,transactionBgColor:t.bgColor||g(e.box.$content)},taskId:e.storage.state.taskId,url:e.storage.state.url});s.context=e,o.addDisposer(S.set(e.appId,s)),e.box.mountStyles(l.styles),e.box.mountStage(s.$slide),e.box.mountFooter(s.$footer),e.box.mountContent(s.$content),o.addDisposer(()=>s.destroy()),C({context:e,viewer:s,sideEffect:o,logger:r}),y(e,()=>{r.info("[Slide] destroy"),o.flushAll()})}};function I(e){const{container:t}=e;t.style.cssText="display:flex;flex-direction:column";const r=new l(e);return t.appendChild(document.createElement("style")).textContent=l.styles,t.appendChild(r.$content),t.appendChild(r.$footer),r.prepare(()=>r.slide.renderSlide(1)),r}function c(e){const t=e.room,r=e.displayer;return t?()=>t.calibrationTimestamp:r?()=>r.beginTimestamp+r.progressTime:()=>Date.now()}function b(e){return e.displayer.logger}function g(e){try{let t=window.getComputedStyle(e).backgroundColor;if(t!=="rgba(0, 0, 0, 0)"&&t!=="transparent")return t=h(t),console.log("[Slide] guess bg color:",t),t;if(e.parentElement)return g(e.parentElement)}catch{}return"#ffffff"}function h(e){const t=f.get(e);if(t&&t.model==="rgb"){const r=t.value,s=(((Math.round(r[0])&255)<<16)+((Math.round(r[1])&255)<<8)+(Math.round(r[2])&255)).toString(16);return"#"+"000000".substring(s.length)+s}else return e}function y(e,t){e.emitter.on("destroy",t)}function C({context:e,viewer:t,sideEffect:r,logger:o}){const s=o.info.bind(o);let n=null;t.prepare(({width:i,height:d,slideCount:u})=>{e.destroyed||(i&&e.box.setStageRatio(d/i),n=e.createWhiteBoardView({size:u}),p())});const{slide:a}=t;function p(){if(e.storage.state.state)s("[Slide] restore",{...e.storage.state.state}),a.setSlideState(e.storage.state.state);else if(e.isAddApp)s("[Slide] kick start"),a.renderSlide(1);else{s("[Slide] wait for restore");const i=r.add(()=>{const u=setInterval(()=>{e.storage.state.state||(s("[Slide] timeout"),a.renderSlide(1))},15e3);return()=>clearInterval(u)}),d=r.addDisposer(e.storage.addStateChangedListener(()=>{e.storage.state.state&&(s("[Slide] restore",{...e.storage.state.state}),a.setSlideState(e.storage.state.state),r.flush(d),r.flush(i))}))}}a.on("stateChange",()=>{e.isWritable&&(s("[Slide] save state",{...a.slideState}),e.storage.setState({state:a.slideState}))}),a.on("syncDispatch",i=>{e.isWritable&&(s("[Slide] dispatch",{...i}),e.dispatchMagixEvent("syncDispatch",i))}),r.addDisposer(e.addMagixEventListener("syncDispatch",({payload:i})=>{s("[Slide] receive",{...i}),a.emit("syncReceive",i)},{fireSelfEventAfterCommit:!0})),a.on("slideChange",i=>{e.isWritable&&n&&(s("[Slide] page to",i),n.jumpPage(i-1))}),t.setReadonly(!e.isWritable),r.addDisposer(e.emitter.on("writableChange",i=>{t.setReadonly(!i)}))}export{A as SlideViewer,R as addHooks,D as default,I as previewSlide,$ as refrigerator,v as version};
