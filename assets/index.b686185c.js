var M=Object.defineProperty,C=Object.defineProperties;var D=Object.getOwnPropertyDescriptors;var f=Object.getOwnPropertySymbols;var y=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable;var _=(t,e,s)=>e in t?M(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,x=(t,e)=>{for(var s in e||(e={}))y.call(e,s)&&_(t,s,e[s]);if(f)for(var s of f(e))w.call(e,s)&&_(t,s,e[s]);return t},S=(t,e)=>C(t,D(e));var E=(t,e)=>{var s={};for(var i in t)y.call(t,i)&&e.indexOf(i)<0&&(s[i]=t[i]);if(t!=null&&f)for(var i of f(t))e.indexOf(i)<0&&w.call(t,i)&&(s[i]=t[i]);return s};import{o as m}from"./side-effect-manager.es.789c7667.js";import{R as O}from"./index.67aa768e.js";import{L as I}from"./logger.4fdb8c5b.js";import"./modulepreload-polyfill.b7f2da20.js";import"./randomColor.21718267.js";function P(t){var o;const e=t.getRoom(),s=t.getDisplayer(),i=s.observerId,n=(o=s.state.roomMembers.find(a=>a.memberId===i))==null?void 0:o.payload,h=(e==null?void 0:e.uid)||(n==null?void 0:n.uid)||"",p=(n==null?void 0:n.nickName)||h;return{memberId:i,uid:h,nickName:p}}function A(t){const e=t.indexOf("?",1);return e!==-1?{search:t.slice(e),pathname:t.slice(0,e)}:{search:"",pathname:t}}function z(t,e){const{pathname:s,search:i}=A(t);return s+(i?`${i}&`:"?")+e}function l(t){return document.createElement(t)}function g(t,e,s){s==null?t.removeAttribute(e):t.setAttribute(e,s)}function u(t,e){return t.appendChild(e)}function R(t){var e;return(e=t.parentNode)==null?void 0:e.removeChild(t)}const L=Promise.resolve();function b(t){const e=[];return{get value(){return t},set(s){t=s,e.forEach(i=>i(t))},subscribe(s){return e.push(s),L.then(()=>s(t)),()=>{e.splice(e.indexOf(s),1)}}}}var W=`.app-talkative-container{width:100%;height:100%;overflow:hidden;display:flex;justify-content:center;align-items:center;flex-direction:column}.app-talkative-container iframe{width:100%;height:100%;border:none;display:block}.app-talkative-footer{position:absolute;bottom:0;left:0;width:100%;display:flex;align-items:center;justify-content:center;gap:4px;box-sizing:border-box;background-color:#fff9;height:26px;padding:0 16px;border-top:1px solid #eeeef7;color:#191919}.telebox-color-scheme-dark .app-talkative-footer{color:#a6a6a8;background:#2d2d33;border-top:none}.app-talkative-page{font-variant-numeric:tabular-nums}.app-talkative-btn{box-sizing:border-box;width:26px;height:26px;font-size:14px;font-family:monospace;margin:0;padding:3px;border:none;border-radius:1px;outline:none;color:currentColor;background:transparent;transition:background .4s;-webkit-tap-highlight-color:rgba(0,0,0,0);cursor:pointer;user-select:none;-webkit-user-select:none}.app-talkative-btn:hover{background:rgba(237,237,240,.9)}.telebox-color-scheme-dark .app-talkative-btn:hover{background:#212126}.telebox-color-scheme-dark .app-talkative-container{color:#eee}.app-talkative-btn:disabled{opacity:0;cursor:default}
`;const J=window.ResizeObserver||O;class B{constructor(e){this.context=e,this.sideEffect=new m,this.box=this.context.getBox(),this.role=b(2),this.ratio=b(16/9),this.$content=l("div"),this.$iframe=l("iframe"),g(this.$content,"class","app-talkative-container"),u(this.$content,this.$iframe),this.$content.dataset.appKind="Talkative"}_on_update_role(e){this.$content.dataset.role=String(e),this.$content.classList.toggle("owner",e===0)}_on_update_ratio(e,s){const{width:i,height:n}=s?s.contentRect:this.$content.getBoundingClientRect();if(i/e>n){const h=n*e;this.$iframe.style.width=`${h}px`,this.$iframe.style.height=""}else if(i/e<n){const h=i/e;this.$iframe.style.width="",this.$iframe.style.height=`${h}px`}}_observe_content_resize(){const e=new J(s=>{this._on_update_ratio(this.ratio.value,s[0])});return e.observe(this.$content),e.disconnect.bind(e)}mount(){return this.box.mountStyles(W),this.box.mountContent(this.$content),this.sideEffect.addDisposer(this.role.subscribe(this._on_update_role.bind(this))),this.sideEffect.addDisposer(this.ratio.subscribe(this._on_update_ratio.bind(this))),this.sideEffect.addDisposer(this._observe_content_resize()),this.destroy.bind(this)}destroy(){this.sideEffect.flushAll(),R(this.$content)}postMessage(e){var s;(s=this.$iframe.contentWindow)==null||s.postMessage(e,"*")}}class T{constructor(e,s,i){this.context=e,this.onPrev=s,this.onNext=i,this.sideEffect=new m,this.box=this.context.getBox(),this.role=b(2),this.text=b("..."),this.$footer=l("div"),this.$btnLeft=l("button"),this.$btnRight=l("button"),this.$span=l("span"),u(this.$footer,this.$btnLeft),u(this.$footer,this.$span),u(this.$footer,this.$btnRight),g(this.$footer,"class","app-talkative-footer"),g(this.$btnLeft,"class","app-talkative-btn app-talkative-btn-left"),g(this.$btnRight,"class","app-talkative-btn app-talkative-btn-right"),g(this.$span,"class","app-talkative-page"),this.$btnLeft.textContent="<",this.$btnRight.textContent=">",this.$btnLeft.addEventListener("click",this.onPrev),this.$btnRight.addEventListener("click",this.onNext)}_on_update_role(e){this.$btnLeft.disabled=e===2,this.$btnRight.disabled=e===2,this.$footer.classList.toggle("owner",e===0)}_on_update_text(e){this.$span.textContent=e}mount(){return this.box.mountFooter(this.$footer),this.sideEffect.addDisposer(this.role.subscribe(this._on_update_role.bind(this))),this.sideEffect.addDisposer(this.text.subscribe(this._on_update_text.bind(this))),this.destroy.bind(this)}destroy(){this.sideEffect.flushAll(),R(this.$footer)}}function j(i){var n=i,{context:t,logger:e}=n,s=E(n,["context","logger"]);const h=new m,p={onPagenum({totalPages:o}){t.getIsWritable()&&o&&t.storage.setState({pageNum:o})},onLoadComplete(o){s.onRatioChanged(o.coursewareRatio),t.getIsWritable()&&o.totalPages&&t.storage.setState({pageNum:o.totalPages});const{page:a,lastMsg:r}=t.storage.state;r&&s.postMessage(r),s.postMessage(JSON.stringify({method:"onJumpPage",toPage:a}))},onFileMessage(o){if(t.getIsWritable()){t.dispatchMagixEvent("broadcast",JSON.stringify(o));const a=JSON.stringify(S(x({},o),{isRestore:!0}));t.storage.setState({lastMsg:a})}}};return h.addDisposer(t.addMagixEventListener("broadcast",({payload:o})=>{s.postMessage(o)})),h.addEventListener(window,"message",o=>{if(!!s.isSentBySelf(o.source))if(typeof o.data=="string")try{const a=JSON.parse(o.data);if(typeof a=="object"&&a!==null){const r=p[a.method];r?r(a):e.warn("unknown message",a)}}catch(a){e.warn("error when parsing message",a)}else typeof o.data=="object"&&o.data!==null&&e.log("unhandled permission command",o.data)}),h.flushAll.bind(h)}const G={kind:"Talkative",setup(t){t.storage.ensureState({src:"https://example.org",uid:"",page:1,pageNum:1,lastMsg:""});const e=(t.getAppOptions()||{}).debug,s=new I("Talkative",e),{uid:i,memberId:n,nickName:h}=P(t),p=new m;s.log("my uid",i);const o=()=>{const{page:d}=t.storage.state;t.getIsWritable()&&d>1&&t.storage.setState({page:d-1})},a=()=>{const{page:d,pageNum:c}=t.storage.state;t.getIsWritable()&&d<c&&t.storage.setState({page:d+1})},r=new B(t),$=new T(t,o,a),v=r.postMessage.bind(r);p.addDisposer(j({context:t,logger:s,postMessage:v,onRatioChanged:r.ratio.set.bind(r.ratio),isSentBySelf:d=>d===r.$iframe.contentWindow})),p.addDisposer(t.storage.addStateChangedListener(()=>{const d=t.storage.state.uid===i?0:2;r.role.set(d),$.role.set(d);const{page:c,pageNum:N}=t.storage.state;v(JSON.stringify({method:"onJumpPage",toPage:c})),$.text.set(`${c}/${N}`)}));const k=()=>{p.addDisposer(r.mount()),p.addDisposer($.mount());const d=t.storage.state.uid===i?0:2,c=`userid=${n}&role=${d}&name=${h}`;r.$iframe.src=z(t.storage.state.src,c)};if(t.storage.state.uid)L.then(k);else{const d=p.addDisposer(t.storage.addStateChangedListener(()=>{t.storage.state.uid&&(p.flush(d),k())}));t.isAddApp&&(s.log("no teacher's uid, setting myself..."),t.storage.setState({uid:i}))}t.emitter.on("destroy",()=>{s.log("destroy"),p.flushAll()})}};export{G as default};
