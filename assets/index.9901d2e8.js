import{o as C}from"./side-effect-manager.es.789c7667.js";import{e as U}from"./ensure-attributes.2c659353.js";import{L as O}from"./logger.4fdb8c5b.js";import"./randomColor.21718267.js";import"./index.67aa768e.js";import"./modulepreload-polyfill.b7f2da20.js";var W=`.netless-app-embedded-page{width:100%;height:100%;position:relative}.netless-app-embedded-page iframe{width:100%;height:100%;border:none;display:block}.netless-app-embedded-page-wb-view{width:100%;height:100%;position:absolute;top:0;left:0;overflow:hidden}
`;function m(s){return typeof s=="object"&&s!==null}const j=new Set(["clicker","selector"]),X={kind:"EmbeddedPage",setup(s){const S=s.getAppOptions()||{},r=s.getDisplayer(),o=s.getRoom(),y=s.getBox(),u=s.getView(),E=S.debug,w="state",d=U(s,{src:"https://example.org",store:{[w]:{}},page:""}),l=new C,p=new O("EmbeddedPage",E),g=e=>{try{return m(e)?JSON.parse(JSON.stringify(e)):e}catch(t){throw p.error("Cannot parse to JSON object",e),t}},b=document.createElement("div");b.dataset.appKind="EmbeddedPage",b.classList.add("netless-app-embedded-page");const h=document.createElement("iframe");b.appendChild(h),y.mountStyles(W),y.mountContent(b);const v=e=>e.map(({memberId:t,payload:a})=>({sessionUID:t,uid:(a==null?void 0:a.uid)||"",userPayload:g(a)})),M=(e,t)=>{let a=null;const n=s.mobxUtils.reaction(e,()=>{a&&(a(),a=null);const i=e();m(i)&&(a=()=>s.objectUtils.unlistenUpdated(i,t),s.objectUtils.listenUpdated(i,t))},{fireImmediately:!0});return()=>{a==null||a(),n()}},c=S.postMessage||(e=>{var t;p.log("Message to SDK",e),(t=h.contentWindow)==null||t.postMessage(e,"*")}),I=S.addMessageListener||((e,t)=>{const a=({data:n,source:i})=>{i!==h.contentWindow||!m(n)||!n.NEAType||(p.log("Message from SDK",n),e(n))};return window.addEventListener("message",a,t),()=>{window.removeEventListener("message",a,t)}});if(u){const e=document.createElement("div");if(e.classList.add("netless-app-embedded-page-wb-view"),b.appendChild(e),s.mountView(e),o){const t=a=>{e.style.pointerEvents=!a||j.has(a)?"none":"auto"};t(o.state.memberState.currentApplianceName),l.add(()=>{const a=n=>{n.memberState&&t(n.memberState.currentApplianceName)};return r.callbacks.on("onRoomStateChanged",a),()=>r.callbacks.off("onRoomStateChanged",a)})}}const A=e=>{u&&m(e)&&u.moveCamera({centerX:e.x,centerY:e.y,scale:e.scale,animationMode:"immediately"})},k=e=>{m(e)&&Object.keys(e).forEach(t=>{if(t!==w){const a=e[t];s.updateAttributes(["store",t],a)}})},N=e=>{if(m(e)&&e.storeId&&m(e.state)){const{storeId:t,state:a}=e;if(!s.getIsWritable()){p.error(`Cannot setState on store ${t} without writable access`,a);return}Object.keys(a).forEach(n=>{s.updateAttributes(["store",t,n],a[n])})}};l.add(()=>{const e=new C,t=n=>{e.add(()=>M(()=>d.store[n],i=>{c({NEAType:"StateChanged",payload:{storeId:n,actions:g(i)}})}),n)};Object.keys(d.store).forEach(t);const a=M(()=>d.store,n=>{c({NEAType:"StoreChanged",payload:g(n)}),d.store&&n.forEach(({key:i,kind:R})=>{switch(R){case 2:{e.flush(i);break}default:{t(i);break}}})});return()=>{e.flushAll(),a()}}),l.add(()=>{const e=t=>{t!=null&&t.roomMembers&&c({NEAType:"RoomMembersChanged",payload:v(t.roomMembers)})};return r.callbacks.on("onRoomStateChanged",e),()=>r.callbacks.off("onRoomStateChanged",e)});const P=e=>{if(!u)p.warn("SetPage: page api is only available with 'scenePath' options enabled.");else{const t=s.getInitScenePath();if(typeof e=="string"&&s.getIsWritable()&&t&&o){const a=[t,e].join("/");o.scenePathType(a)==="none"&&o.putScenes(t,[{name:e}]),s.setScenePath(a),s.updateAttributes(["page"],e)}}};l.add(()=>{const e=(t,a)=>{c({NEAType:"PageChanged",payload:{oldValue:a,newValue:t}})};return s.mobxUtils.reaction(()=>d.page,e)}),l.add(()=>{const e=()=>{const t=s.getIsWritable();c({NEAType:"WritableChanged",payload:t}),p.log(`WritableChange changed to ${t}`)};return s.emitter.on("writableChange",e),()=>s.emitter.off("writableChange",e)});const f=`channel-${s.appId}`,L=e=>{s.getIsWritable()&&o&&o.dispatchMagixEvent(f,e)};l.add(()=>{const e=t=>{t.event===f&&t.authorId!==r.observerId&&c({NEAType:"ReceiveMagixMessage",payload:t.payload})};return r.addMagixEventListener(f,e),()=>r.removeMagixEventListener(f,e)});const T=()=>{var a;const e=r.observerId,t=(a=r.state.roomMembers.find(n=>n.memberId===e))==null?void 0:a.payload;c({NEAType:"Init",payload:{appId:s.appId,page:d.page,writable:s.getIsWritable(),roomMembers:v(r.state.roomMembers),debug:E,store:g(d.store),mainStoreId:w,meta:{sessionUID:e,uid:(o==null?void 0:o.uid)||(t==null?void 0:t.uid)||"",roomUUID:o==null?void 0:o.uuid,userPayload:g(t)}}})};l.add(()=>I(e=>{switch(e.NEAType){case"Init":{T();break}case"SetState":{N(e.payload);break}case"SetStore":{k(e.payload);break}case"SetPage":{P(e.payload);break}case"SendMagixMessage":{L(e.payload);break}case"MoveCamera":{A(e.payload);break}}})),s.emitter.on("destroy",()=>{p.log("destroy"),l.flushAll()}),h.src=d.src}};export{X as default};
