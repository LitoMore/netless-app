import{o as b,R as x}from"./index.d9353ee8.js";import{L as S}from"./logger.dce509b7.js";import"./modulepreload-polyfill.b7f2da20.js";import"./randomColor.95dbb546.js";function E(t){var d;const e=t.room,s=t.displayer,o=s.observerId,r=(d=s.state.roomMembers.find(m=>m.memberId===o))==null?void 0:d.payload,i=(e==null?void 0:e.uid)||(r==null?void 0:r.uid)||"",n=(r==null?void 0:r.nickName)||i;return{memberId:o,uid:i,nickName:n}}function N(t){const e=t.indexOf("?",1);return e!==-1?{search:t.slice(e),pathname:t.slice(0,e)}:{search:"",pathname:t}}function L(t,e){const{pathname:s,search:o}=N(t);return s+(o?`${o}&`:"?")+e}function c(t){return document.createElement(t)}function g(t,e,s){s==null?t.removeAttribute(e):t.setAttribute(e,s)}function f(t,e){return t.appendChild(e)}function _(t){var e;return(e=t.parentNode)==null?void 0:e.removeChild(t)}const y=Promise.resolve();function u(t){const e=[];return{get value(){return t},set(s){t=s,e.forEach(o=>o(t))},subscribe(s){return e.push(s),y.then(()=>s(t)),()=>{e.splice(e.indexOf(s),1)}}}}const R=`.app-talkative-container{width:100%;height:100%;overflow:hidden;display:flex;justify-content:center;align-items:center;flex-direction:column}.app-talkative-container iframe{width:100%;height:100%;border:none;display:block}.app-talkative-footer{display:flex;align-items:center;justify-content:center;gap:4px;box-sizing:border-box;background-color:#fff9;height:26px;padding:0 16px;border-top:1px solid #eeeef7;color:#191919}.telebox-color-scheme-dark .app-talkative-footer{color:#a6a6a8;background:#2d2d33;border-top:none}.app-talkative-page{font-variant-numeric:tabular-nums}.app-talkative-btn{box-sizing:border-box;width:26px;height:26px;font-size:14px;font-family:monospace;margin:0;padding:3px;border:none;border-radius:1px;outline:none;color:currentColor;background:transparent;transition:background .4s;-webkit-tap-highlight-color:rgba(0,0,0,0);cursor:pointer;user-select:none;-webkit-user-select:none}.app-talkative-btn:hover{background:rgba(237,237,240,.9)}.telebox-color-scheme-dark .app-talkative-btn:hover{background:#212126}.telebox-color-scheme-dark .app-talkative-container{color:#eee}.app-talkative-btn:disabled{opacity:0;cursor:default}
`,M=window.ResizeObserver||x;class C{constructor(e){this.context=e,this.sideEffect=new b,this.box=this.context.box,this.role=u(2),this.ratio=u(16/9),this.$content=c("div"),this.$iframe=c("iframe"),g(this.$content,"class","app-talkative-container"),f(this.$content,this.$iframe),this.$content.dataset.appKind="Talkative"}_on_update_role(e){this.$content.dataset.role=String(e),this.$content.classList.toggle("owner",e===0)}_on_update_ratio(e,s){const{width:o,height:r}=s?s.contentRect:this.$content.getBoundingClientRect();if(o/e>r){const i=r*e;this.$iframe.style.width=`${i}px`,this.$iframe.style.height=""}else if(o/e<r){const i=o/e;this.$iframe.style.width="",this.$iframe.style.height=`${i}px`}}_observe_content_resize(){const e=new M(s=>{this._on_update_ratio(this.ratio.value,s[0])});return e.observe(this.$content),e.disconnect.bind(e)}mount(){return this.box.mountStyles(R),this.box.mountContent(this.$content),this.sideEffect.addDisposer(this.role.subscribe(this._on_update_role.bind(this))),this.sideEffect.addDisposer(this.ratio.subscribe(this._on_update_ratio.bind(this))),this.sideEffect.addDisposer(this._observe_content_resize()),this.destroy.bind(this)}destroy(){this.sideEffect.flushAll(),_(this.$content)}postMessage(e){var s;(s=this.$iframe.contentWindow)==null||s.postMessage(e,"*")}}class D{constructor(e,s,o){this.context=e,this.onPrev=s,this.onNext=o,this.sideEffect=new b,this.box=this.context.box,this.role=u(2),this.text=u("..."),this.$footer=c("div"),this.$btnLeft=c("button"),this.$btnRight=c("button"),this.$span=c("span"),f(this.$footer,this.$btnLeft),f(this.$footer,this.$span),f(this.$footer,this.$btnRight),g(this.$footer,"class","app-talkative-footer"),g(this.$btnLeft,"class","app-talkative-btn app-talkative-btn-left"),g(this.$btnRight,"class","app-talkative-btn app-talkative-btn-right"),g(this.$span,"class","app-talkative-page"),this.$btnLeft.textContent="<",this.$btnRight.textContent=">",this.$btnLeft.addEventListener("click",this.onPrev),this.$btnRight.addEventListener("click",this.onNext)}_on_update_role(e){this.$btnLeft.disabled=e===2,this.$btnRight.disabled=e===2,this.$footer.classList.toggle("owner",e===0)}_on_update_text(e){this.$span.textContent=e}mount(){return this.box.mountFooter(this.$footer),this.sideEffect.addDisposer(this.role.subscribe(this._on_update_role.bind(this))),this.sideEffect.addDisposer(this.text.subscribe(this._on_update_text.bind(this))),this.destroy.bind(this)}destroy(){this.sideEffect.flushAll(),_(this.$footer)}}function O({context:t,logger:e,...s}){const o=new b,r={onPagenum({totalPages:i}){t.isWritable&&i&&t.storage.setState({pageNum:i})},onLoadComplete(i){s.onRatioChanged(i.coursewareRatio),t.isWritable&&i.totalPages&&t.storage.setState({pageNum:i.totalPages});const{page:n,lastMsg:d}=t.storage.state;d&&s.postMessage(d),s.postMessage(JSON.stringify({method:"onJumpPage",toPage:n}))},onFileMessage(i){if(t.isWritable){t.dispatchMagixEvent("broadcast",JSON.stringify(i));const n=JSON.stringify({...i,isRestore:!0});t.storage.setState({lastMsg:n})}}};return o.addDisposer(t.addMagixEventListener("broadcast",({payload:i})=>{s.postMessage(i)})),o.addEventListener(window,"message",i=>{if(!!s.isSentBySelf(i.source))if(typeof i.data=="string")try{const n=JSON.parse(i.data);if(typeof n=="object"&&n!==null){const d=r[n.method];d?d(n):e.warn("unknown message",n)}}catch(n){e.warn("error when parsing message",n)}else typeof i.data=="object"&&i.data!==null&&e.log("unhandled permission command",i.data)}),o.flushAll.bind(o)}const J={kind:"Talkative",setup(t){t.storage.ensureState({src:"https://example.org",uid:"",page:1,pageNum:1,lastMsg:""});const e=(t.getAppOptions()||{}).debug,s=new S("Talkative",e),{uid:o,memberId:r,nickName:i}=E(t),n=new b;s.log("my uid",o);const d=()=>{const{page:a}=t.storage.state;t.isWritable&&a>1&&t.storage.setState({page:a-1})},m=()=>{const{page:a,pageNum:p}=t.storage.state;t.isWritable&&a<p&&t.storage.setState({page:a+1})},h=new C(t),l=new D(t,d,m),v=h.postMessage.bind(h);n.addDisposer(O({context:t,logger:s,postMessage:v,onRatioChanged:h.ratio.set.bind(h.ratio),isSentBySelf:a=>a===h.$iframe.contentWindow})),n.addDisposer(t.storage.addStateChangedListener(()=>{const a=t.storage.state.uid===o?0:2;h.role.set(a),l.role.set(a);const{page:p,pageNum:$}=t.storage.state;v(JSON.stringify({method:"onJumpPage",toPage:p})),l.text.set(`${p}/${$}`)}));const k=()=>{n.addDisposer(h.mount()),n.addDisposer(l.mount());const a=t.storage.state.uid===o?0:2,p=`userid=${r}&role=${a}&name=${i}`;h.$iframe.src=L(t.storage.state.src,p),h.role.set(a),l.role.set(a);const{page:$,pageNum:w}=t.storage.state;l.text.set(`${$}/${w}`)};if(t.storage.state.uid)y.then(k);else{const a=n.addDisposer(t.storage.addStateChangedListener(()=>{t.storage.state.uid&&(n.flush(a),k())}));t.isAddApp&&(s.log("no teacher's uid, setting myself..."),t.storage.setState({uid:o}))}t.emitter.on("destroy",()=>{s.log("destroy"),n.flushAll()})}};export{J as default};
