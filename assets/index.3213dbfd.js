var U=Object.defineProperty;var O=(a,r,n)=>r in a?U(a,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[r]=n;var w=(a,r,n)=>(O(a,typeof r!="symbol"?r+"":r,n),n);import{T as I}from"./vendor.c4986934.js";import{e as W}from"./ensure-attributes.2c659353.js";import{r as D}from"./randomColor.520bb1bf.js";var $=`.netless-app-embedded-page{width:100%;height:100%;position:relative}.netless-app-embedded-page iframe{width:100%;height:100%;border:none;display:block}.netless-app-embedded-page-wb-view{width:100%;height:100%;position:absolute;top:0;left:0;overflow:hidden}
`;class J{constructor(r="NetlessApp",n="error"){w(this,"kind");w(this,"debug");w(this,"color",D({luminosity:"dark"}));this.kind=r,this.debug=n}log(...r){if(this.debug===!0||this.debug==="log")return this._log("log",r)}warn(...r){if(this.debug&&this.debug!=="error")return this._log("warn",r)}error(...r){if(this.debug)return this._log("error",r)}_log(r,n){console[r](`%c[${this.kind}]:`,`color: ${this.color}; font-weight: bold;`,...n)}}function m(a){return typeof a=="object"&&a!==null}const _=new Set(["clicker","selector"]),Y={kind:"EmbeddedPage",setup(a){const r=a.getAppOptions()||{},n=a.getDisplayer(),i=a.getRoom(),E=a.getBox(),h=a.getView(),v=r.debug,y="state",l=W(a,{src:"https://example.org",store:{[y]:{}},page:""}),c=new I,p=new J("EmbeddedPage",v),b=e=>{try{return m(e)?JSON.parse(JSON.stringify(e)):e}catch(t){throw p.error("Cannot parse to JSON object",e),t}},u=document.createElement("div");u.dataset.appKind="EmbeddedPage",u.classList.add("netless-app-embedded-page");const f=document.createElement("iframe");u.appendChild(f),E.mountStyles($),E.mountContent(u);const C=e=>e.map(({memberId:t,payload:s})=>({sessionUID:t,uid:(s==null?void 0:s.uid)||"",userPayload:b(s)})),M=(e,t)=>{let s=null;const o=a.mobxUtils.reaction(e,()=>{s&&(s(),s=null);const d=e();m(d)&&(s=()=>a.objectUtils.unlistenUpdated(d,t),a.objectUtils.listenUpdated(d,t))},{fireImmediately:!0});return()=>{s==null||s(),o()}},g=r.postMessage||(e=>{var t;p.log("Message to SDK",e),(t=f.contentWindow)==null||t.postMessage(e,"*")}),k=r.addMessageListener||((e,t)=>{const s=({data:o,source:d})=>{d!==f.contentWindow||!m(o)||!o.NEAType||(p.log("Message from SDK",o),e(o))};return window.addEventListener("message",s,t),()=>{window.removeEventListener("message",s,t)}});if(h){const e=document.createElement("div");if(e.classList.add("netless-app-embedded-page-wb-view"),u.appendChild(e),a.mountView(e),i){const t=s=>{e.style.pointerEvents=!s||_.has(s)?"none":"auto"};t(i.state.memberState.currentApplianceName),c.add(()=>{const s=o=>{o.memberState&&t(o.memberState.currentApplianceName)};return n.callbacks.on("onRoomStateChanged",s),()=>n.callbacks.off("onRoomStateChanged",s)})}}const A=e=>{h&&m(e)&&h.moveCamera({centerX:e.x,centerY:e.y,scale:e.scale,animationMode:"immediately"})},N=e=>{m(e)&&Object.keys(e).forEach(t=>{if(t!==y){const s=e[t];a.updateAttributes(["store",t],s)}})},P=e=>{if(m(e)&&e.storeId&&m(e.state)){const{storeId:t,state:s}=e;if(!a.getIsWritable()){p.error(`Cannot setState on store ${t} without writable access`,s);return}Object.keys(s).forEach(o=>{a.updateAttributes(["store",t,o],s[o])})}};c.add(()=>{const e=new I,t=o=>{e.add(()=>M(()=>l.store[o],d=>{g({NEAType:"StateChanged",payload:{storeId:o,actions:b(d)}})}),o)};Object.keys(l.store).forEach(t);const s=M(()=>l.store,o=>{g({NEAType:"StoreChanged",payload:b(o)}),l.store&&o.forEach(({key:d,kind:R})=>{switch(R){case 2:{e.flush(d);break}default:{t(d);break}}})});return()=>{e.flushAll(),s()}}),c.add(()=>{const e=t=>{(t==null?void 0:t.roomMembers)&&g({NEAType:"RoomMembersChanged",payload:C(t.roomMembers)})};return n.callbacks.on("onRoomStateChanged",e),()=>n.callbacks.off("onRoomStateChanged",e)});const T=e=>{if(!h)p.warn("SetPage: page api is only available with 'scenePath' options enabled.");else{const t=a.getInitScenePath();if(typeof e=="string"&&a.getIsWritable()&&t&&i){const s=[t,e].join("/");i.scenePathType(s)==="none"&&i.putScenes(t,[{name:e}]),a.setScenePath(s),a.updateAttributes(["page"],e)}}};c.add(()=>{const e=(t,s)=>{g({NEAType:"PageChanged",payload:{oldValue:s,newValue:t}})};return a.mobxUtils.reaction(()=>l.page,e)}),c.add(()=>{const e=()=>{const t=a.getIsWritable();g({NEAType:"WritableChanged",payload:t}),p.log(`WritableChange changed to ${t}`)};return a.emitter.on("writableChange",e),()=>a.emitter.off("writableChange",e)});const S=`channel-${a.appId}`,j=e=>{a.getIsWritable()&&i&&i.dispatchMagixEvent(S,e)};c.add(()=>{const e=t=>{t.event===S&&t.authorId!==n.observerId&&g({NEAType:"ReceiveMagixMessage",payload:t.payload})};return n.addMagixEventListener(S,e),()=>n.removeMagixEventListener(S,e)});const L=()=>{var s;const e=n.observerId,t=(s=n.state.roomMembers.find(o=>o.memberId===e))==null?void 0:s.payload;g({NEAType:"Init",payload:{appId:a.appId,page:l.page,writable:a.getIsWritable(),roomMembers:C(n.state.roomMembers),debug:v,store:b(l.store),mainStoreId:y,meta:{sessionUID:e,uid:(i==null?void 0:i.uid)||(t==null?void 0:t.uid)||"",roomUUID:i==null?void 0:i.uuid,userPayload:b(t)}}})};c.add(()=>k(e=>{switch(e.NEAType){case"Init":{L();break}case"SetState":{P(e.payload);break}case"SetStore":{N(e.payload);break}case"SetPage":{T(e.payload);break}case"SendMagixMessage":{j(e.payload);break}case"MoveCamera":{A(e.payload);break}}})),a.emitter.on("destroy",()=>{p.log("destroy"),c.flushAll()}),f.src=l.src}};export{Y as default};
