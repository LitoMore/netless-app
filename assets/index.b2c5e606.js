import{o as C}from"./index.254e60a2.js";import{e as O}from"./ensure-attributes.2c659353.js";import{L as T}from"./logger.6370ef03.js";import"./modulepreload-polyfill.b7f2da20.js";import"./randomColor.6ce59d8f.js";var j=(()=>`.netless-app-embedded-page{width:100%;height:100%;position:relative}.netless-app-embedded-page iframe{width:100%;height:100%;border:none;display:block}.netless-app-embedded-page-wb-view{width:100%;height:100%;position:absolute;top:0;left:0;overflow:hidden}
`)();function c(a){return typeof a=="object"&&a!==null}const B={kind:"EmbeddedPage",setup(a){const f=a.getAppOptions()||{},{displayer:i,room:o,box:S}=a,w=f.debug,y="state",d=O(a,{src:"https://example.org",store:{[y]:{}},page:""}),p=new C,m=new T("EmbeddedPage",w),b=e=>{try{return c(e)?JSON.parse(JSON.stringify(e)):e}catch(t){throw m.error("Cannot parse to JSON object",e),t}},g=document.createElement("div");g.dataset.appKind="EmbeddedPage",g.classList.add("netless-app-embedded-page");const u=document.createElement("iframe");g.appendChild(u),S.mountStyles(j),S.mountContent(g),S.setHighlightStage(!1);const M=e=>e.map(({memberId:t,payload:s})=>({sessionUID:t,uid:(s==null?void 0:s.uid)||"",userPayload:b(s)})),v=(e,t)=>{let s=null;const r=a.mobxUtils.reaction(e,()=>{s&&(s(),s=null);const n=e();c(n)&&(s=()=>a.objectUtils.unlistenUpdated(n,t),a.objectUtils.listenUpdated(n,t))},{fireImmediately:!0});return()=>{s==null||s(),r()}},l=f.postMessage||(e=>{var t;m.log("Message to SDK",e),(t=u.contentWindow)==null||t.postMessage(e,"*")}),I=f.addMessageListener||((e,t)=>{const s=({data:r,source:n})=>{n!==u.contentWindow||!c(r)||!r.NEAType||(m.log("Message from SDK",r),e(r))};return window.addEventListener("message",s,t),()=>{window.removeEventListener("message",s,t)}});let E;const A=e=>{E&&c(e)&&E.moveCamera({centerX:e.x,centerY:e.y})},N=e=>{c(e)&&Object.keys(e).forEach(t=>{if(t!==y){const s=e[t];a.updateAttributes(["store",t],s)}})},P=e=>{if(c(e)&&e.storeId&&c(e.state)){const{storeId:t,state:s}=e;if(!a.isWritable){m.error(`Cannot setState on store ${t} without writable access`,s);return}Object.keys(s).forEach(r=>{a.updateAttributes(["store",t,r],s[r])})}};p.add(()=>{const e=new C,t=r=>{e.add(()=>v(()=>d.store[r],n=>{l({NEAType:"StateChanged",payload:{storeId:r,actions:b(n)}})}),r)};Object.keys(d.store).forEach(t);const s=v(()=>d.store,r=>{l({NEAType:"StoreChanged",payload:b(r)}),d.store&&r.forEach(({key:n,kind:W})=>{switch(W){case 2:{e.flush(n);break}default:{t(n);break}}})});return()=>{e.flushAll(),s()}}),p.add(()=>{const e=t=>{t!=null&&t.roomMembers&&l({NEAType:"RoomMembersChanged",payload:M(t.roomMembers)})};return i.callbacks.on("onRoomStateChanged",e),()=>i.callbacks.off("onRoomStateChanged",e)});const k=e=>{E||(E=a.createWhiteBoardView());const t=a.getInitScenePath();if(typeof e=="string"&&a.isWritable&&t&&o){const s=[t,e].join("/");o.scenePathType(s)==="none"&&o.putScenes(t,[{name:e}]),a.setScenePath(s),a.updateAttributes(["page"],e)}};p.add(()=>{const e=(t,s)=>{l({NEAType:"PageChanged",payload:{oldValue:s,newValue:t}})};return a.mobxUtils.reaction(()=>d.page,e)}),p.add(()=>{const e=()=>{const t=a.isWritable;l({NEAType:"WritableChanged",payload:t}),m.log(`WritableChange changed to ${t}`)};return a.emitter.on("writableChange",e),()=>a.emitter.off("writableChange",e)});const h=`channel-${a.appId}`,L=e=>{a.isWritable&&o&&o.dispatchMagixEvent(h,e)};p.add(()=>{const e=t=>{t.event===h&&t.authorId!==i.observerId&&l({NEAType:"ReceiveMagixMessage",payload:t.payload})};return i.addMagixEventListener(h,e),()=>i.removeMagixEventListener(h,e)});const U=()=>{var s;const e=i.observerId,t=(s=i.state.roomMembers.find(r=>r.memberId===e))==null?void 0:s.payload;l({NEAType:"Init",payload:{appId:a.appId,page:d.page,writable:a.isWritable,roomMembers:M(i.state.roomMembers),debug:w,store:b(d.store),mainStoreId:y,meta:{sessionUID:e,uid:(o==null?void 0:o.uid)||(t==null?void 0:t.uid)||"",roomUUID:o==null?void 0:o.uuid,userPayload:b(t)}}})};p.add(()=>I(e=>{switch(e.NEAType){case"Init":{U();break}case"SetState":{P(e.payload);break}case"SetStore":{N(e.payload);break}case"SetPage":{k(e.payload);break}case"SendMagixMessage":{L(e.payload);break}case"MoveCamera":{A(e.payload);break}}})),a.emitter.on("destroy",()=>{m.log("destroy"),p.flushAll()}),u.src=d.src}};export{B as default};
