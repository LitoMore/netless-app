var R=Object.defineProperty,O=Object.defineProperties;var $=Object.getOwnPropertyDescriptors;var k=Object.getOwnPropertySymbols;var E=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var v=(e,s,a)=>s in e?R(e,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[s]=a,N=(e,s)=>{for(var a in s||(s={}))E.call(s,a)&&v(e,a,s[a]);if(k)for(var a of k(s))J.call(s,a)&&v(e,a,s[a]);return e},S=(e,s)=>O(e,$(s));import{U as L,V as A}from"./vendor.8ff05f75.js";import{L as C}from"./logger.2c785e5a.js";import"./randomColor.f3878626.js";var I=`.app-talkative-container{width:100%;height:100%;overflow:hidden;display:flex;justify-content:center;align-items:center}.app-talkative-container iframe{width:100%;height:100%;border:none;display:block}.telebox-color-scheme-dark .app-talkative-container{color:#eee}
`;function j(e){var m;const s=e.getRoom(),a=e.getDisplayer(),g=a.observerId,r=(m=a.state.roomMembers.find(u=>u.memberId===g))==null?void 0:m.payload,p=(s==null?void 0:s.uid)||(r==null?void 0:r.uid)||"",d=(r==null?void 0:r.nickName)||p;return{memberId:g,uid:p,nickName:d}}const z=window.ResizeObserver||A,P={kind:"Talkative",setup(e){const s=(e.getAppOptions()||{}).debug,a=new C("Talkative",s),{uid:g,memberId:r,nickName:p}=j(e),d=new L;e.storage.ensureState({src:"https://example.org",uid:"",page:1,pageNum:1,lastMsg:""}),e.storage.state.uid||(e.isAddApp||a.log("no teacher's uid, fallback to a random guy"),e.storage.setState({uid:g}));const m=e.storage.state.uid===g?0:2,u=`?userid=${r}&role=${m}&name=${p}`,b=e.getBox();b.mountStyles(I);const c=document.createElement("div");c.className="app-talkative-container",b.mountContent(c);const i=document.createElement("iframe");c.appendChild(i);let l=16/9;const w=t=>{var y;const{width:o,height:n}=((y=t[0])==null?void 0:y.contentRect)||c.getBoundingClientRect();if(o/l>n){const f=n*l;i.style.width=`${f}px`,i.style.height=""}else if(o/l<n){const f=o/l;i.style.width="",i.style.height=`${f}px`}};d.add(()=>{const t=new z(w);return t.observe(c),t.disconnect.bind(t)});const h=t=>{var o;(o=i.contentWindow)==null||o.postMessage(t,"*")},M={onPagenum({totalPages:t}){e.storage.setState({pageNum:t})},onLoadComplete(t){l=t.coursewareRatio,w([]),e.storage.setState({pageNum:t.totalPages});const{page:o,lastMsg:n}=e.storage.state;n&&h(n),h(JSON.stringify({method:"onJumpPage",toPage:o}))},onFileMessage(t){e.dispatchMagixEvent("broadcast",JSON.stringify(t));const o=JSON.stringify(S(N({},t),{isRestore:!0}));e.storage.setState({lastMsg:o})}};d.addDisposer(e.addMagixEventListener("broadcast",({payload:t})=>{h(t)})),d.addEventListener(window,"message",t=>{if(t.source===i.contentWindow)if(typeof t.data=="string")try{const o=JSON.parse(t.data);if(typeof o=="object"&&o!==null){const n=M[o.method];n?n(o):a.warn("unknown message",o)}}catch(o){a.warn("error when parsing message",o)}else typeof t.data=="object"&&t.data!==null&&a.log("unhandled permission command",t.data)}),e.emitter.on("destroy",()=>{d.flushAll()}),i.src=e.storage.state.src+u}};export{P as default};
