import{o as S}from"./index.7dcfa8da.js";import"./modulepreload-polyfill.b7f2da20.js";function k(){return new Worker("./fit-curve-worker.e5fbe713.js")}let y=(e=21)=>{let t="",s=crypto.getRandomValues(new Uint8Array(e));for(;e--;){let r=s[e]&63;r<36?t+=r.toString(36):r<62?t+=(r-26).toString(36).toUpperCase():r<63?t+="_":t+="-"}return t};function U(){return new Worker("./bezier-q.8fae6e32.js")}function $(){return document.createElementNS("http://www.w3.org/2000/svg","svg")}function w(){return document.createElementNS("http://www.w3.org/2000/svg","path")}function g(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}}function v(e,t){const{left:s,top:r}=t.getBoundingClientRect();return{x:e.clientX-s|0,y:e.clientY-r|0}}const E=({x:e,y:t})=>`M${e},${t}`,b=({x:e,y:t})=>`L${e},${t}`,A=(e,{x:t,y:s})=>`Q${e.x},${e.y} ${t},${s}`,M=(e,t,{x:s,y:r})=>`C${e.x},${e.y} ${t.x},${t.y} ${s} ${r}`;class P{constructor(t){this.path=t}remove(){this.path.remove()}}class I extends P{replace(t){if(t.length<2)this.path.setAttribute("d","");else{const s=t.length-1;let r=E(t[0])+b(g(t[0],t[1]));for(let n=1;n<s;++n)r+=A(t[n],g(t[n],t[n+1]));r+=b(t[s]),this.path.setAttribute("d",r)}}}class x extends P{replace(t){if(t.length<1)this.path.setAttribute("d","");else{const s=t.length-1;let r=E(t[0][0]);for(let n=0;n<=s;++n){const l=t[n];r+=M(l[1],l[2],l[3])}this.path.setAttribute("d",r)}}}const W=3,D=new U,C=new Map,j=()=>new Promise(e=>requestAnimationFrame(e));D.onmessage=e=>{const{id:t,points:s}=e.data,r=C.get(t);r&&r(s)};async function V(e,t){const s=e.newPath(),{length:r}=t;for(let n=2;n<r;++n)s.replace(t.slice(0,n)),await j();s.replace(t)}function F(e,t){t=t.map(r=>r.map(n=>({...n})));const s=y();C.set(s,r=>V(e,r)),D.postMessage({id:s,curves:t,step:W})}class f{constructor(t,s,r){this.target=t,this.onDraw=s,this.onDrawEnd=r,this.currentPathUID="",this.pointerDown=n=>{n.isPrimary&&(this.target.setPointerCapture(n.pointerId),this.currentPathUID=y(),this.onDraw(this.currentPathUID,v(n,this.target),n.timeStamp))},this.pointerMove=n=>{n.isPrimary&&this.currentPathUID&&this.onDraw(this.currentPathUID,v(n,this.target),n.timeStamp)},this.pointerUp=n=>{this.currentPathUID&&(this.onDrawEnd(this.currentPathUID,n.timeStamp),this.currentPathUID="",this.target.releasePointerCapture(n.pointerId))},t.addEventListener("pointerdown",this.pointerDown,!1),t.addEventListener("pointermove",this.pointerMove,!1),t.addEventListener("pointerup",this.pointerUp,!1),t.addEventListener("pointerleave",this.pointerUp,!1)}clear(){let t=null;for(;t=this.target.firstChild;)t.remove()}destroy(){this.target.removeEventListener("pointerdown",this.pointerDown,!1),this.target.removeEventListener("pointermove",this.pointerMove,!1),this.target.removeEventListener("pointerup",this.pointerUp,!1),this.target.removeEventListener("pointerleave",this.pointerUp,!1)}newPath(){const t=w();return this.target.append(t),new I(t)}newCurve(){const t=w();return this.target.append(t),new x(t)}initCurves(t){for(const s of Object.values(t))this.newCurve().replace(s)}}f.createSVGElement=$;const O={kind:"Paint",setup(e){const t=e.box,s=e.createStorage("curves",e.storage.state.curves||{}),r=f.createSVGElement();r.setAttribute("fill","transparent"),r.setAttribute("stroke",t.darkMode?"#fff":"#000"),r.setAttribute("stroke-width","2"),Object.assign(r.style,{display:"block",width:"100%",height:"100%",touchAction:"none"}),t.mountContent(r);const n=new S;n.addDisposer(t.onValChanged("darkMode",i=>{r.setAttribute("stroke",i?"#fff":"#000")}));const l=new k,m=i=>{e.isWritable&&e.dispatchMagixEvent("broadcast",i)},h={};n.addDisposer(e.addMagixEventListener("broadcast",({authorId:i,payload:a})=>{if(i===e.displayer.observerId)return;const{clear:p,pid:o,done:L}=a;p&&(c.clear(),c.initCurves(s.state)),o&&L&&F(c,s.state[o])}));const c=new f(r,(i,a,p)=>{let o=h[i];o||(o=h[i]={points:[],path:c.newPath()}),o.points.push(a),o.path.replace(o.points),o.timeStamp=p},i=>{const a=h[i];!a||(a.points.length<2?a.path.remove():l.postMessage({id:i,path:a.points,error:5}),delete h[i])});c.initCurves(s.state),l.onmessage=i=>{const{id:a,curves:p}=i.data;e.isWritable&&(s.setState({[a]:p}),m({pid:a,done:!0}))};const d=document.createElement("button");d.classList.add("netless-app-paint-clear-btn"),d.textContent="CLEAR ALL",d.addEventListener("click",()=>{c.clear(),s.emptyStorage(),m({clear:!0})});const u=document.createElement("div");u.append(d),Object.assign(u.style,{display:"flex",justifyContent:"center"}),t.mountFooter(u),e.emitter.on("destroy",()=>{console.log("[Paint]: destroy"),n.flushAll(),c.destroy()})}};export{O as default};
