import{o as x}from"./index.254e60a2.js";import{e as I}from"./ensure-attributes.2c659353.js";import"./modulepreload-polyfill.b7f2da20.js";function W(){return new Worker("assets/fit-curve-worker.2b9b0d9d.js",{type:"module"})}let k=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;){let r=n[e]&63;r<36?t+=r.toString(36):r<62?t+=(r-26).toString(36).toUpperCase():r<63?t+="_":t+="-"}return t};function j(){return new Worker("assets/bezier-q.3b0d34cf.js",{type:"module"})}function V(){return document.createElementNS("http://www.w3.org/2000/svg","svg")}function D(){return document.createElementNS("http://www.w3.org/2000/svg","path")}function P(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}}function L(e,t){const{left:n,top:r}=t.getBoundingClientRect();return{x:e.clientX-n|0,y:e.clientY-r|0}}const C=({x:e,y:t})=>`M${e},${t}`,$=({x:e,y:t})=>`L${e},${t}`,F=(e,{x:t,y:n})=>`Q${e.x},${e.y} ${t},${n}`,B=(e,t,{x:n,y:r})=>`C${e.x},${e.y} ${t.x},${t.y} ${n} ${r}`;class A{constructor(t){this.path=t}remove(){this.path.remove()}}class G extends A{replace(t){if(t.length<2)this.path.setAttribute("d","");else{const n=t.length-1;let r=C(t[0])+$(P(t[0],t[1]));for(let s=1;s<n;++s)r+=F(t[s],P(t[s],t[s+1]));r+=$(t[n]),this.path.setAttribute("d",r)}}}class O extends A{replace(t){if(t.length<1)this.path.setAttribute("d","");else{const n=t.length-1;let r=C(t[0][0]);for(let s=0;s<=n;++s){const c=t[s];r+=B(c[1],c[2],c[3])}this.path.setAttribute("d",r)}}}const Q=3,S=new j,U=new Map,R=()=>new Promise(e=>requestAnimationFrame(e));S.onmessage=e=>{const{id:t,points:n}=e.data,r=U.get(t);r&&r(n)};async function q(e,t){const n=e.newPath(),{length:r}=t;for(let s=2;s<r;++s)n.replace(t.slice(0,s)),await R();n.replace(t)}function N(e,t){t=t.map(r=>r.map(s=>({...s})));const n=k();U.set(n,r=>q(e,r)),S.postMessage({id:n,curves:t,step:Q})}class w{constructor(t,n,r){this.target=t,this.onDraw=n,this.onDrawEnd=r,this.currentPathUID="",this.pointerDown=s=>{s.isPrimary&&(this.currentPathUID=k(),this.onDraw(this.currentPathUID,L(s,this.target),s.timeStamp))},this.pointerMove=s=>{s.isPrimary&&this.currentPathUID&&this.onDraw(this.currentPathUID,L(s,this.target),s.timeStamp)},this.pointerUp=s=>{this.currentPathUID&&(this.onDrawEnd(this.currentPathUID,s.timeStamp),this.currentPathUID="")},t.addEventListener("pointerdown",this.pointerDown,!1),t.addEventListener("pointermove",this.pointerMove,!1),t.addEventListener("pointerup",this.pointerUp,!1),t.addEventListener("pointerleave",this.pointerUp,!1)}clear(){let t=null;for(;t=this.target.firstChild;)t.remove()}destroy(){this.target.removeEventListener("pointerdown",this.pointerDown,!1),this.target.removeEventListener("pointermove",this.pointerMove,!1),this.target.removeEventListener("pointerup",this.pointerUp,!1),this.target.removeEventListener("pointerleave",this.pointerUp,!1)}newPath(){const t=D();return this.target.append(t),new G(t)}newCurve(){const t=D();return this.target.append(t),new O(t)}initCurves(t){for(const n of Object.values(t))this.newCurve().replace(n)}}w.createSVGElement=V;const _={kind:"Paint",setup(e){var E,y;const{appId:t}=e,n=e.box,r=e.room,s=e.displayer,c=I(e,{curves:{}});n.setHighlightStage(!1);const l=w.createSVGElement();l.setAttribute("fill","transparent"),l.setAttribute("stroke",n.darkMode?"#fff":"#000"),l.setAttribute("stroke-width","2"),Object.assign(l.style,{display:"block",width:"100%",height:"100%"}),n.mountContent(l),(E=n.$content)==null||E.addEventListener("touchstart",i=>i.preventDefault()),(y=n.$content)==null||y.addEventListener("touchmove",i=>i.preventDefault());const m=new x;m.addDisposer(n.onValChanged("darkMode",i=>{l.setAttribute("stroke",i?"#fff":"#000")}));const g=new W,d=`channel-${t}`,b=i=>{e.isWritable&&(r==null||r.dispatchMagixEvent(d,i))},u={},M=i=>{if(i.event===d&&i.authorId!==s.observerId){const{clear:a,pid:h,done:o}=i.payload;a&&(p.clear(),p.initCurves(c.curves)),h&&o&&N(p,c.curves[h])}};m.add(()=>(s.addMagixEventListener(d,M),()=>s==null?void 0:s.removeMagixEventListener(d)));const p=new w(l,(i,a,h)=>{let o=u[i];o||(o=u[i]={points:[],path:p.newPath()}),o.points.push(a),o.path.replace(o.points),o.timeStamp=h},i=>{const a=u[i];!a||(a.points.length<2?a.path.remove():g.postMessage({id:i,path:a.points,error:5}),delete u[i])});p.initCurves(c.curves),g.onmessage=i=>{const{id:a,curves:h}=i.data;e.isWritable&&(e.updateAttributes(["curves",a],h),b({pid:a,done:!0}))},n.mountStyles(`
      .telebox-color-scheme-dark .netless-app-paint-clear-btn {
        color-scheme: dark;
      }
    `);const f=document.createElement("button");f.classList.add("netless-app-paint-clear-btn"),f.textContent="CLEAR ALL",f.addEventListener("click",()=>{p.clear(),e.updateAttributes(["curves"],{}),b({clear:!0})});const v=document.createElement("div");v.append(f),Object.assign(v.style,{display:"flex",justifyContent:"center"}),n.mountFooter(v),e.emitter.on("destroy",()=>{console.log("[Paint]: destroy"),m.flushAll(),p.destroy()})}};export{_ as default};
