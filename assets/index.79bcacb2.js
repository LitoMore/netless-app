import{o as u,R as w}from"./index.254e60a2.js";import{L as x}from"./logger.6370ef03.js";import"./modulepreload-polyfill.b7f2da20.js";import"./randomColor.6ce59d8f.js";function S(t){var d;const e=t.room,s=t.displayer,o=s.observerId,a=(d=s.state.roomMembers.find(b=>b.memberId===o))==null?void 0:d.payload,i=(e==null?void 0:e.uid)||(a==null?void 0:a.uid)||"",n=(a==null?void 0:a.nickName)||i;return{memberId:o,uid:i,nickName:n}}function E(t){const e=t.indexOf("?",1);return e!==-1?{search:t.slice(e),pathname:t.slice(0,e)}:{search:"",pathname:t}}function L(t,e){const{pathname:s,search:o}=E(t);return s+(o?`${o}&`:"?")+e}function c(t){return document.createElement(t)}function l(t,e,s){s==null?t.removeAttribute(e):t.setAttribute(e,s)}function g(t,e){return t.appendChild(e)}function k(t){var e;return(e=t.parentNode)==null?void 0:e.removeChild(t)}const _=Promise.resolve();function f(t){const e=[];return{get value(){return t},set(s){t=s,e.forEach(o=>o(t))},subscribe(s){return e.push(s),_.then(()=>s(t)),()=>{e.splice(e.indexOf(s),1)}}}}var N=(()=>`.app-talkative-container{width:100%;height:100%;overflow:hidden;display:flex;justify-content:center;align-items:center;flex-direction:column}.app-talkative-container iframe{width:100%;height:100%;border:none;display:block}.app-talkative-footer{position:absolute;bottom:0;left:0;width:100%;display:flex;align-items:center;justify-content:center;gap:4px;box-sizing:border-box;background-color:#fff9;height:26px;padding:0 16px;border-top:1px solid #eeeef7;color:#191919}.telebox-color-scheme-dark .app-talkative-footer{color:#a6a6a8;background:#2d2d33;border-top:none}.app-talkative-page{font-variant-numeric:tabular-nums}.app-talkative-btn{box-sizing:border-box;width:26px;height:26px;font-size:14px;font-family:monospace;margin:0;padding:3px;border:none;border-radius:1px;outline:none;color:currentColor;background:transparent;transition:background .4s;-webkit-tap-highlight-color:rgba(0,0,0,0);cursor:pointer;user-select:none;-webkit-user-select:none}.app-talkative-btn:hover{background:rgba(237,237,240,.9)}.telebox-color-scheme-dark .app-talkative-btn:hover{background:#212126}.telebox-color-scheme-dark .app-talkative-container{color:#eee}.app-talkative-btn:disabled{opacity:0;cursor:default}
`)();const R=window.ResizeObserver||w;class M{constructor(e){this.context=e,this.sideEffect=new u,this.box=this.context.box,this.role=f(2),this.ratio=f(16/9),this.$content=c("div"),this.$iframe=c("iframe"),l(this.$content,"class","app-talkative-container"),g(this.$content,this.$iframe),this.$content.dataset.appKind="Talkative"}_on_update_role(e){this.$content.dataset.role=String(e),this.$content.classList.toggle("owner",e===0)}_on_update_ratio(e,s){const{width:o,height:a}=s?s.contentRect:this.$content.getBoundingClientRect();if(o/e>a){const i=a*e;this.$iframe.style.width=`${i}px`,this.$iframe.style.height=""}else if(o/e<a){const i=o/e;this.$iframe.style.width="",this.$iframe.style.height=`${i}px`}}_observe_content_resize(){const e=new R(s=>{this._on_update_ratio(this.ratio.value,s[0])});return e.observe(this.$content),e.disconnect.bind(e)}mount(){return this.box.setHighlightStage(!1),this.box.mountStyles(N),this.box.mountContent(this.$content),this.sideEffect.addDisposer(this.role.subscribe(this._on_update_role.bind(this))),this.sideEffect.addDisposer(this.ratio.subscribe(this._on_update_ratio.bind(this))),this.sideEffect.addDisposer(this._observe_content_resize()),this.destroy.bind(this)}destroy(){this.sideEffect.flushAll(),k(this.$content)}postMessage(e){var s;(s=this.$iframe.contentWindow)==null||s.postMessage(e,"*")}}class C{constructor(e,s,o){this.context=e,this.onPrev=s,this.onNext=o,this.sideEffect=new u,this.box=this.context.box,this.role=f(2),this.text=f("..."),this.$footer=c("div"),this.$btnLeft=c("button"),this.$btnRight=c("button"),this.$span=c("span"),g(this.$footer,this.$btnLeft),g(this.$footer,this.$span),g(this.$footer,this.$btnRight),l(this.$footer,"class","app-talkative-footer"),l(this.$btnLeft,"class","app-talkative-btn app-talkative-btn-left"),l(this.$btnRight,"class","app-talkative-btn app-talkative-btn-right"),l(this.$span,"class","app-talkative-page"),this.$btnLeft.textContent="<",this.$btnRight.textContent=">",this.$btnLeft.addEventListener("click",this.onPrev),this.$btnRight.addEventListener("click",this.onNext)}_on_update_role(e){this.$btnLeft.disabled=e===2,this.$btnRight.disabled=e===2,this.$footer.classList.toggle("owner",e===0)}_on_update_text(e){this.$span.textContent=e}mount(){return this.box.mountFooter(this.$footer),this.sideEffect.addDisposer(this.role.subscribe(this._on_update_role.bind(this))),this.sideEffect.addDisposer(this.text.subscribe(this._on_update_text.bind(this))),this.destroy.bind(this)}destroy(){this.sideEffect.flushAll(),k(this.$footer)}}function D({context:t,logger:e,...s}){const o=new u,a={onPagenum({totalPages:i}){t.isWritable&&i&&t.storage.setState({pageNum:i})},onLoadComplete(i){s.onRatioChanged(i.coursewareRatio),t.isWritable&&i.totalPages&&t.storage.setState({pageNum:i.totalPages});const{page:n,lastMsg:d}=t.storage.state;d&&s.postMessage(d),s.postMessage(JSON.stringify({method:"onJumpPage",toPage:n}))},onFileMessage(i){if(t.isWritable){t.dispatchMagixEvent("broadcast",JSON.stringify(i));const n=JSON.stringify({...i,isRestore:!0});t.storage.setState({lastMsg:n})}}};return o.addDisposer(t.addMagixEventListener("broadcast",({payload:i})=>{s.postMessage(i)})),o.addEventListener(window,"message",i=>{if(!!s.isSentBySelf(i.source))if(typeof i.data=="string")try{const n=JSON.parse(i.data);if(typeof n=="object"&&n!==null){const d=a[n.method];d?d(n):e.warn("unknown message",n)}}catch(n){e.warn("error when parsing message",n)}else typeof i.data=="object"&&i.data!==null&&e.log("unhandled permission command",i.data)}),o.flushAll.bind(o)}const W={kind:"Talkative",setup(t){t.storage.ensureState({src:"https://example.org",uid:"",page:1,pageNum:1,lastMsg:""});const e=(t.getAppOptions()||{}).debug,s=new x("Talkative",e),{uid:o,memberId:a,nickName:i}=S(t),n=new u;s.log("my uid",o);const d=()=>{const{page:r}=t.storage.state;t.isWritable&&r>1&&t.storage.setState({page:r-1})},b=()=>{const{page:r,pageNum:p}=t.storage.state;t.isWritable&&r<p&&t.storage.setState({page:r+1})},h=new M(t),m=new C(t,d,b),$=h.postMessage.bind(h);n.addDisposer(D({context:t,logger:s,postMessage:$,onRatioChanged:h.ratio.set.bind(h.ratio),isSentBySelf:r=>r===h.$iframe.contentWindow})),n.addDisposer(t.storage.addStateChangedListener(()=>{const r=t.storage.state.uid===o?0:2;h.role.set(r),m.role.set(r);const{page:p,pageNum:y}=t.storage.state;$(JSON.stringify({method:"onJumpPage",toPage:p})),m.text.set(`${p}/${y}`)}));const v=()=>{n.addDisposer(h.mount()),n.addDisposer(m.mount());const r=t.storage.state.uid===o?0:2,p=`userid=${a}&role=${r}&name=${i}`;h.$iframe.src=L(t.storage.state.src,p)};if(t.storage.state.uid)_.then(v);else{const r=n.addDisposer(t.storage.addStateChangedListener(()=>{t.storage.state.uid&&(n.flush(r),v())}));t.isAddApp&&(s.log("no teacher's uid, setting myself..."),t.storage.setState({uid:o}))}t.emitter.on("destroy",()=>{s.log("destroy"),n.flushAll()})}};export{W as default};
