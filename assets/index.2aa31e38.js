import{_ as g,A as M,p as S,y,K as T,v as d,u as N}from"./index.0e117cfb.js";import{c as I}from"./clsx.m.f2bc012f.js";import"./modulepreload-polyfill.b7f2da20.js";function x(o){return`netless-app-gomoku-${o}`}function W(o,e){var t;return(((t=o.find(s=>s.uid===e))==null?void 0:t.payload)||{}).nickName||e}const E=15;function A(o,e,r){const t=o[e][r];if(t==="")return"";let s;s=1;for(let n=e;o[n+1]&&o[++n][r]===t;)++s;for(let n=e;o[n-1]&&o[--n][r]===t;)++s;if(s>=5)return t;s=1;for(let n=r;o[e][n+1]&&o[e][++n]===t;)++s;for(let n=r;o[e][n-1]&&o[e][--n]===t;)++s;if(s>=5)return t;s=1;for(let n=e,i=r;o[n+1]&&o[++n][--i]===t;)++s;for(let n=e,i=r;o[n-1]&&o[--n][++i]===t;)++s;if(s>=5)return t;s=1;for(let n=e,i=r;o[n+1]&&o[++n][++i]===t;)++s;for(let n=e,i=r;o[n-1]&&o[--n][--i]===t;)++s;return s>=5?t:""}function B(o){return Object.keys(o).map(Number).sort()}function R(){return Array.from({length:E},()=>Array(E).fill(""))}function _(o){const e=R();for(const r of B(o)){const{i:t,j:s,c:n}=o[r];e[t][s]=n;const i=A(e,t,s);if(i)return i}return""}function D(o){const e=R();return B(o).forEach(r=>{const{c:t,i:s,j:n}=o[r];e[s][n]=t}),e}function F(o){return Object.keys(o).reduce((e,r)=>Math.max(e,Number(r)),-1)+1}const G={xPlayer:null,oPlayer:null,turn:"o"};function $(o){const[e,r]=S(()=>o.isWritable);return y(()=>o.emitter.on("writableChange",()=>r(o.isWritable)),[o]),e}function O(o,e,r){const[t]=S(()=>o.createStorage(e,r())),[s,n]=S(t.state),i=g(()=>t.setState.bind(t),[o]);return y(()=>t.addStateChangedListener(()=>{n({...t.state})}),[t]),[s,i]}function j(o){const[e,r]=S(()=>o.members);return y(()=>o.emitter.on("roomMembersChange",r),[o]),e}function K(o){return g(()=>{var e;return((e=o.currentMember)==null?void 0:e.uid)||""},[o])}function Y(o){const[e,r]=O(o,"gomoku",()=>G),[t,s]=O(o,"operations",()=>({})),n=$(o),i=j(o),c=K(o),b=g(()=>D(t),[t]),[l,u]=g(()=>{const a=_(t);return a?a==="o"?[e.oPlayer,e.xPlayer]:[e.xPlayer,e.oPlayer]:[null,null]},[t,e.oPlayer,e.xPlayer]),[z,p]=g(()=>{const a=l&&(W(i,l)||l),f=u&&(W(i,u)||u);return[a,f]},[i,l,u]),C=g(()=>n?e.oPlayer&&e.oPlayer===c?e.turn!=="o":e.xPlayer&&e.xPlayer===c?e.turn!=="x":Boolean(e.oPlayer&&e.xPlayer):!0,[e.oPlayer,e.xPlayer,e.turn,c,n]),k=g(()=>!n||e.oPlayer===c||e.xPlayer===c?!1:!e.oPlayer||!e.xPlayer,[e.xPlayer,e.oPlayer,c,n]),P=g(()=>l!==null?!1:e.oPlayer===c&&!e.xPlayer||e.xPlayer===c&&!e.oPlayer,[e.xPlayer,e.oPlayer,c]),v=M(()=>{e.oPlayer?e.xPlayer||r({xPlayer:c}):r({oPlayer:c})},[e.oPlayer,e.xPlayer,c]),h=M((a,f)=>{if(n){const m={i:a,j:f,c:e.turn};s({[F(t)]:m}),r({turn:e.turn==="o"?"x":"o"})}},[t,e.turn]);return{board:b,turn:e.turn,readonly:C,winner:l,loser:u,winnerName:z,loserName:p,memberID:c,isShowLogin:k,isShowWaiting:P,onLogin:v,onOperation:h}}class w{constructor(e,r){this.row=e,this.col=r}}function L(){}function q(o,e,r){return o.row!==e||o.col!==r}function J(o){o.resetTransform?o.resetTransform():o.setTransform(1,0,0,1,0,0)}class U{constructor(){this.padding=12,this.rows=15,this.cellSize=30,this.$container=null,this.board=[],this.cursor=new w(-1,-1),this.color="",this.resizeObserver=null,this.disposers=new Set,this.onClick=L,this.onPointerMove=({clientX:e,clientY:r})=>{const{left:t,top:s}=this.canvas.getBoundingClientRect(),n=Math.round((e-t-this.padding)/this.cellSize),i=Math.round((r-s-this.padding)/this.cellSize);this.setCursor(n,i)},this.tryMove=()=>{if(this.hasCursor()&&this.color!==""){const{row:e,col:r}=this.cursor;this.onClick(e,r)}},this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d")}mount(e){if(this.$container=e,e){e.appendChild(this.canvas),e.addEventListener("pointermove",this.onPointerMove),e.addEventListener("click",this.tryMove);const r=new ResizeObserver(this.refresh.bind(this));this.resizeObserver=r,r.observe(e),this.disposers.add(()=>{e.removeEventListener("pointermove",this.onPointerMove),e.removeEventListener("click",this.tryMove),r.disconnect()}),this.refresh()}return this.unmount.bind(this)}unmount(){this.disposers.forEach(e=>e()),this.disposers.clear(),this.cursor=new w(-1,-1),this.board=[],this.onClick=L,this.$container=null,this.resizeObserver=null}setBoard(e){this.board!==e&&(this.board=e,this.refresh())}onOperation(e){this.onClick=e}setCursor(e,r){q(this.cursor,e,r)&&(this.cursor=new w(e,r),this.refresh())}setColor(e){this.color!==e&&(this.color=e,this.refresh())}refresh(){if(!this.$container)return;const{$container:e,canvas:r,context:t}=this,{width:s,height:n}=e.getBoundingClientRect(),i=Math.min(s,n);r.style.width=r.style.height=`${i}px`;const c=window.devicePixelRatio,b=Math.floor(i*c);r.width=r.height=b,J(t),t.scale(c,c);const l=this.padding,u=i-l*2,z=this.rows,p=u/(z-1),C=p/Math.E;this.cellSize=p,t.fillStyle="#FF851B",t.fillRect(0,0,b,b),t.strokeStyle="#000",t.lineWidth=4,t.lineJoin="round",t.strokeRect(l,l,u,u),t.fillRect(l,l,u,u),t.lineWidth=1,t.beginPath();for(let h=1;h<=z-2;++h){const a=l+h*p;t.moveTo(l,a),t.lineTo(l+u,a),t.moveTo(a,l),t.lineTo(a,l+u)}t.stroke(),t.fillStyle="#000",t.beginPath();for(const h of[3,11])for(const a of[3,11]){const f=l+h*p,m=l+a*p;t.moveTo(f,m),t.ellipse(f,m,2,2,0,0,2*Math.PI)}t.fill();const k=[],P=[];this.board.forEach((h,a)=>{h.forEach((f,m)=>{f==="o"&&k.push(new w(a,m)),f==="x"&&P.push(new w(a,m))})}),t.lineWidth=2,t.strokeStyle="#000";const v=({row:h,col:a})=>{const f=h*p+l,m=a*p+l;t.moveTo(f,m),t.ellipse(f,m,C,C,0,0,2*Math.PI)};P.length&&(t.fillStyle="#000",t.beginPath(),P.forEach(v),t.stroke(),t.fill()),k.length&&(t.fillStyle="#fff",t.beginPath(),k.forEach(v),t.stroke(),t.fill()),this.color&&this.hasCursor()&&(t.strokeStyle="transparent",t.fillStyle=this.color==="o"?"#ffffff70":"#00000070",t.beginPath(),v(this.cursor),t.stroke(),t.fill())}hasCursor(){const{row:e,col:r}=this.cursor;return this.board[e]&&this.board[e][r]===""}}function Z({board:o,turn:e,readonly:r,onOperation:t}){const s=T(null),[n]=S(()=>new U);return y(()=>n.mount(s.current),[n]),y(()=>n.setBoard(o),[o]),y(()=>n.setColor(e),[e]),y(()=>n.onOperation(t),[t]),d("div",{className:I(x("board"),{"is-readonly":r}),ref:s})}function H({onLogin:o}){return d("div",{className:x("login")},d("button",{className:x("login-start"),onClick:o},"Start"))}function Q(){return d("div",{className:x("waiting")},"Waiting for other players\u2026")}function V({memberID:o,winner:e,loser:r}){return!e&&!r?null:d("div",{className:x("winner")},o===e?"You Win!":o===r?"You Lose!":`${e} Wins!`)}function X({context:o}){const e=Y(o);return d("div",{class:"netless-app-gomoku"},d(Z,{board:e.board,readonly:e.readonly,turn:e.turn,onOperation:e.onOperation}),e.isShowLogin&&d(H,{onLogin:e.onLogin}),e.isShowWaiting&&d(Q,null),(e.winner||e.loser)&&d(V,{winner:e.winnerName,loser:e.loserName,memberID:e.memberID}))}const ee=`.netless-app-gomoku-container,.netless-app-gomoku,.netless-app-gomoku-board{width:100%;height:100%;overflow:hidden;box-sizing:border-box;position:relative}.netless-app-gomoku-board{font-size:0;text-align:center;cursor:default}.netless-app-gomoku-board canvas{cursor:pointer}.netless-app-gomoku-board.is-readonly{pointer-events:none}.netless-app-gomoku-board.is-readonly canvas{cursor:default}.netless-app-gomoku-login{position:absolute;z-index:100;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;background:#ffbe76}.netless-app-gomoku-login-start{border:0;background:#f0932b;width:100%;height:50%;cursor:pointer;font-size:20px;color:#fff}.netless-app-gomoku-winner{position:absolute;z-index:101;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#f39c12;color:#fff;font-size:50px}.netless-app-gomoku-waiting{position:absolute;z-index:101;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#f39c12;color:#fff;font-size:30px}
`,ne={kind:"Gomoku",config:{minwidth:.3,minheight:.3,width:9/16*.5,height:.5},setup(o){o.box.mountStyles(ee);const e=document.createElement("div");e.className="netless-app-gomoku-container",o.box.mountContent(e),N(d(X,{context:o}),e),o.emitter.on("destroy",()=>{N(null,e)})}};export{ne as default};
